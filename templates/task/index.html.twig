{% extends 'base.html.twig' %}

{% block title %}
	{% if project %}
		T√¢ches de
		{{ project.title }}
		- TaskFlow
	{% else %}
		Mes T√¢ches - TaskFlow
	{% endif %}
{% endblock %}

{% block body %}
	<div class="container-fluid">
		<div class="row mb-4">
			<div class="col-12">
				<div class="d-flex justify-content-between align-items-center flex-wrap">
					<div class="mb-2 mb-md-0">
						{% if project %}
							<h1 class="h3 mb-1">T√¢ches de
								{{ project.title }}</h1>
							<p class="text-muted mb-0">{{ project.title }}
								compte
								{{ project.tasksCount }}
								t√¢ches ({{ project.completedTasksCount }}
								termin√©es)</p>
						{% else %}
							<h1 class="h3 mb-1">Toutes mes t√¢ches</h1>
							<p class="text-muted mb-0">Retrouvez toutes vos t√¢ches ici</p>
						{% endif %}
					</div>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-12">
				{% if tasks is empty %}
					<div class="tasks-empty-state">
						<div class="tasks-empty-icon">
							<i class="fas fa-check-double"></i>
						</div>
						{% if project %}
							<h4 class="tasks-empty-title mb-3">Toutes les t√¢ches du projet ont √©t√© termin√©es ! üéâ</h4>
							<p class="tasks-empty-description mb-4">Bravo ! Ce projet est termin√©. Vous pouvez en ajouter d'autres depuis votre tableau de bord.</p>
							<a href="{{ path('task_new', {project: project.id}) }}" class="btn btn-primary">
								<i class="fas fa-plus me-2"></i>Ajouter une nouvelle t√¢che
							</a>
						{% else %}
							<h4 class="tasks-empty-title mb-3">Aucune t√¢che pour le moment</h4>
							<p class="tasks-empty-description mb-4">Cr√©ez votre premi√®re t√¢che pour commencer √† organiser votre travail.</p>
							<a href="{{ path('task_new') }}" class="btn btn-primary">
								<i class="fas fa-plus me-2"></i>Cr√©er une nouvelle t√¢che
							</a>
						{% endif %}
					</div>
				{% else %}
					{# Vue Tableau pour les grands √©crans #}
					<div class="d-none d-md-block">
						<div class="custom-table responsive-table">
							<div class="card-body">
								<div class="table-responsive">
									<table class="table table-hover align-middle mb-0">
										<thead>
											<tr>
												<th>Titre</th>
												{% if not project %}
													<th>Projet</th>
												{% endif %}
												<th>Responsable</th>
												<th>Priorit√©</th>
												<th>Date limite</th>
												<th>Statut</th>
												<th class="d-none d-sm-table-cell text-end">Actions</th>
											</tr>
										</thead>
										<tbody>
											{% for task in tasks %}
												<tr class="task-row">
													<td data-label="Titre">
														{{ task.title }}
													</td>
													{% if not project %}
														<td data-label="Projet">
															<span class="text-muted">
																<i class="fas fa-folder me-1"></i>
																{{ task.project.title }}
															</span>
														</td>
													{% endif %}
													<td data-label="Responsable">
														{% if task.assignee %}
															{{ task.assignee.fullName }}
														{% else %}
															<span class="text-muted fst-italic">Non assign√©</span>
														{% endif %}
													</td>
													<td data-label="Priorit√©">
														{% if task.priority == 'high' %}
															<span class="table-badge danger">Haute</span>
														{% elseif task.priority == 'medium' %}
															<span class="table-badge warning">Moyenne</span>
														{% else %}
															<span class="table-badge secondary">Basse</span>
														{% endif %}
													</td>
													<td data-label="Date limite">
														{% if task.dueDate %}
															<span class="text-muted">{{ task.dueDate|date('d/m/Y') }}</span>
														{% else %}
															<span class="text-muted fst-italic">Non d√©finie</span>
														{% endif %}
													</td>
													<td data-label="Statut">
														<span class="task-status-badge task-status-{{ task.status }}">{{ task.statusLabel }}</span>
													</td>
													<td data-label="Actions" class="text-end">
														<div class="table-actions">
															<a href="{{ path('task_show', {id: task.id}) }}" class="table-action-btn view" title="Voir les d√©tails">
																<i class="fas fa-eye"></i>
															</a>

															{% if task.project.owner == app.user %}
																<button type="button" class="table-action-btn delete delete-task-btn" data-bs-toggle="modal" data-bs-target="#deleteTaskModal" data-task-id="{{ task.id }}" data-task-title="{{ task.title }}" title="Supprimer la t√¢che">
																	<i class="fas fa-trash"></i>
																</button>
															{% endif %}
														</div>
													</td>
												</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>

								{# Pagination #}
								{% if pages is defined and pages > 1 %}
									<nav aria-label="Page navigation" class="tasks-pagination">
										<ul class="pagination justify-content-center">
											<li class="page-item {{ currentPage == 1 ? 'disabled' : '' }}">
												<a class="page-link" href="{{ path('task_index', {project: project ? project.id : null, page: currentPage - 1}) }}" aria-label="Previous">
													<span aria-hidden="true">&laquo;</span>
												</a>
											</li>
											{% for page in 1..pages %}
												<li class="page-item {{ currentPage == page ? 'active' : '' }}">
													<a class="page-link" href="{{ path('task_index', {project: project ? project.id : null, page: page}) }}">{{ page }}</a>
												</li>
											{% endfor %}
											<li class="page-item {{ currentPage == pages ? 'disabled' : '' }}">
												<a class="page-link" href="{{ path('task_index', {project: project ? project.id : null, page: currentPage + 1}) }}" aria-label="Next">
													<span aria-hidden="true">&raquo;</span>
												</a>
											</li>
										</ul>
									</nav>
								{% endif %}
							</div>
						</div>
					</div>

					{# Vue Cartes pour les petits √©crans #}
					<div class="d-md-none">
						{% for task in tasks %}
							<div class="task-card">
								<div class="task-card-body">
									<h5 class="task-card-title">
										{{ task.title }}
									</h5>
									<ul class="task-card-meta">
										{% if not project %}
											<li>
												<strong>Projet :</strong>
												<span class="text-muted">
													<i class="fas fa-folder me-1"></i>
													{{ task.project.title }}
												</span>
											</li>
										{% endif %}
										<li>
											<strong>Responsable :</strong>
											{% if task.assignee %}
												{{ task.assignee.fullName }}
											{% else %}
												<span class="fst-italic">Non assign√©</span>
											{% endif %}
										</li>
										<li>
											<strong>Priorit√© :</strong>
											{% if task.priority == 'high' %}
												<span class="table-badge danger">Haute</span>
											{% elseif task.priority == 'medium' %}
												<span class="table-badge warning">Moyenne</span>
											{% else %}
												<span class="table-badge secondary">Basse</span>
											{% endif %}
										</li>
										<li>
											<strong>Date limite :</strong>
											{% if task.dueDate %}
												{{ task.dueDate|date('d/m/Y') }}
											{% else %}
												<span class="fst-italic">Non d√©finie</span>
											{% endif %}
										</li>
										<li>
											<strong>Statut :</strong>
											<span class="task-status-badge task-status-{{ task.status }}">{{ task.statusLabel }}</span>
										</li>
									</ul>
									<div class="table-actions mt-3">
										<a href="{{ path('task_show', {id: task.id}) }}" class="table-action-btn view" title="Voir les d√©tails">
											<i class="fas fa-eye"></i>
										</a>

										{% if task.project.owner == app.user %}
											<button type="button" class="table-action-btn delete" data-bs-toggle="modal" data-bs-target="#deleteTaskModal" data-task-id="{{ task.id }}" data-task-title="{{ task.title }}" title="Supprimer la t√¢che">
												<i class="fas fa-trash"></i>
											</button>
										{% endif %}
									</div>
								</div>
							</div>
						{% endfor %}
					</div>
				{% endif %}
			</div>
		</div>
	</div>

	<div class="modal fade delete-task-modal" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="deleteTaskModalLabel">
						<i class="fas fa-exclamation-triangle text-danger me-2"></i>
						Confirmer la suppression
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>√ätes-vous s√ªr de vouloir supprimer la t√¢che
						<strong id="taskTitlePlaceholder"></strong>
						?</p>
					<div class="alert alert-warning">
						<i class="fas fa-exclamation-triangle me-2"></i>
						<strong>Attention :</strong>
						Cette action est irr√©versible.
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
					<form method="post" id="deleteTaskForm" class="d-inline">
						<input type="hidden" name="_token" id="deleteTaskToken">
						<button type="submit" class="btn btn-danger">
							<i class="fas fa-trash me-2"></i>Supprimer d√©finitivement
						</button>
					</form>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const deleteTaskModal = new bootstrap.Modal(document.getElementById('deleteTaskModal'));
			const taskTitleElement = document.getElementById('taskTitlePlaceholder');
			const deleteTaskForm = document.getElementById('deleteTaskForm');
			const deleteTaskTokenInput = document.getElementById('deleteTaskToken');
			const deleteButtons = document.querySelectorAll('.delete-task-btn');

			const csrfTokens = {
			{% for task in tasks %}
				'{{ task.id }}': '{{ csrf_token('delete' ~ task.id) }}'{{ not loop.last ? ',' : '' }}
			{% endfor %}
			};

			deleteButtons.forEach(button => {
				button.addEventListener('click', function (event) {
					const taskId = this.getAttribute('data-task-id');
					const taskTitle = this.getAttribute('data-task-title');

					if (taskTitleElement) {
						taskTitleElement.textContent = '"' + taskTitle + '"';
					}

					if (deleteTaskForm) {
						const deletePath = "{{ path('task_delete', {id: 'TASK_ID'}) }}";
						deleteTaskForm.action = deletePath.replace('TASK_ID', taskId);
					}

					if (deleteTaskTokenInput) {
						const token = csrfTokens[taskId];
						if (token) {
							deleteTaskTokenInput.value = token;
						} else {
							console.error('Token CSRF introuvable pour la t√¢che ID:', taskId);
						}
					}
				});
			});
		});
	</script>
{% endblock %}