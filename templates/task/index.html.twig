{% extends 'base.html.twig' %}

{% block title %}
	{% if project %}
		Tâches de
		{{ project.title }}
		- TaskFlow
	{% else %}
		Mes Tâches - TaskFlow
	{% endif %}
{% endblock %}

{% block body %}
	<div class="container-fluid">
		<nav aria-label="breadcrumb" class="mb-3">
			<ol class="breadcrumb">
				{% if project %}
					<li class="breadcrumb-item">
						<a href="{{ path('project_index') }}" class="text-decoration-none">
							<i class="fas fa-folder me-1"></i>Mes Projets
						</a>
					</li>
					<li class="breadcrumb-item">
						<a href="{{ path('project_show', {id: project.id}) }}" class="text-decoration-none">
							{{ project.title }}
						</a>
					</li>
					<li class="breadcrumb-item active">Tâches</li>
				{% else %}
					<li class="breadcrumb-item active">
						<i class="fas fa-tasks me-1"></i>Mes Tâches
					</li>
				{% endif %}
			</ol>
		</nav>

		<div class="row mb-4">
			<div class="col-12">
				<div class="d-flex justify-content-between align-items-center flex-wrap">
					<div class="mb-2 mb-md-0">
						<h1 class="h3 mb-2">
							✅
							{% if project %}Tâches de
								{{ project.title }}{% else %}Mes Tâches
							{% endif %}
						</h1>
						<p class="text-muted mb-0 d-none d-md-block">
							{% if project %}
								Gérez les tâches de ce projet
							{% else %}
								Vue d'ensemble de toutes vos tâches
							{% endif %}
						</p>
					</div>
					<div class="d-none d-sm-flex gap-2 header-actions">
						{% if project %}
							<div class="dropdown">
								<button class="btn btn-outline-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
									<i class="fas fa-plus me-1 me-md-2"></i>
									<span class="d-none d-sm-inline">Ajout rapide</span>
								</button>
								<div class="dropdown-menu dropdown-menu-quick-add p-3" style="min-width: 300px;">
									<form id="quickAddForm" method="post" action="{{ project ? path('task_quick_add', {id: project.id}) : '#' }}">
										<input type="hidden" name="_token" value="{{ csrf_token('quick-add') }}">
										<div class="mb-2">
											<input type="text" name="title" class="form-control" placeholder="Titre de la tâche" required>
										</div>
										<button type="submit" class="btn btn-success btn-sm w-100">
											<i class="fas fa-plus me-1"></i>Ajouter
										</button>
									</form>
								</div>
							</div>
						{% endif %}
						<a href="{{ path('task_new', project ? {project: project.id} : {}) }}" class="btn btn-success">
							<i class="fas fa-plus me-1 me-md-2"></i>
							<span class="d-none d-sm-inline">Nouvelle tâche</span>
							<span class="d-sm-none">Nouveau</span>
						</a>
					</div>
				</div>
			</div>
		</div>

		<div class="card border-0 shadow-sm mb-4">
			<div class="card-body">
				<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
					<h5 class="card-title mb-0">
						<i class="fas fa-filter me-2"></i>Filtres
					</h5>
				</div>
				<form method="get" class="row g-3">
					{% if project %}
						<input type="hidden" name="project" value="{{ project.id }}">
					{% endif %}

					{% if not project %}
						<div class="col-md-4">
							<select class="form-select" name="project" id="projectFilter" aria-label="Filtrer par projet">
								<option value="">Tous les projets</option>
								{% for proj in projects %}
									<option value="{{ proj.id }}" {{ app.request.get('project') == proj.id ? 'selected' : '' }}>
										{{ proj.title }}
									</option>
								{% endfor %}
							</select>
						</div>
					{% endif %}
					<div class="col-md-4">
						<select class="form-select" name="status" id="statusFilter" aria-label="Filtrer par statut">
							<option value="">Tous les statuts</option>
							{% for label, value in status_choices %}
								<option value="{{ value }}" {{ current_status == value ? 'selected' : '' }}>
									{{ label }}
								</option>
							{% endfor %}
						</select>
					</div>
					<div class="col-md-4">
						<select class="form-select" name="priority" id="priorityFilter" aria-label="Filtrer par priorité">
							<option value="">Toutes les priorités</option>
							{% for label, value in priority_choices %}
								<option value="{{ value }}" {{ current_priority == value ? 'selected' : '' }}>
									{{ label }}
								</option>
							{% endfor %}
						</select>
					</div>

					<div class="col-12">
						<div class="d-flex gap-2">
							<button type="submit" class="btn btn-primary">
								<i class="fas fa-check me-2"></i>Appliquer
							</button>
							<a href="{{ path('task_index', project ? {project: project.id} : {}) }}" class="btn btn-outline-secondary">
								<i class="fas fa-times me-2"></i>Réinitialiser
							</a>
						</div>
					</div>
				</form>
			</div>
		</div>

		<div id="tasks-container">
			{% if tasks is empty %}
				<div class="text-center py-5">
					<div class="mb-4">
						<i class="fas fa-check-square fa-5x text-muted"></i>
					</div>
					<h4 class="mb-3">
						{% if current_status or current_priority or app.request.get('project') %}
							Aucune tâche ne correspond à vos filtres.
						{% else %}
							Vous n'avez aucune tâche pour le moment !
						{% endif %}
					</h4>
					<p class="text-muted mb-4">
						Créez votre première tâche pour commencer à vous organiser.
					</p>
					<a href="{{ path('task_new', project ? {project: project.id} : {}) }}" class="btn btn-success btn-lg">
						<i class="fas fa-plus me-2"></i>
						Créer une tâche
					</a>
				</div>
			{% else %}
				<div id="list-view">
					<div class="table-responsive">
						<table class="table table-hover align-middle">
							<thead class="table-light">
								<tr>
									<th>Titre</th>
									<th class="d-none d-sm-table-cell">Description</th>
									<th class="d-none d-lg-table-cell">Date limite</th>
									<th>Statut</th>
									<th>Priorité</th>
									<th class="text-center">Actions</th>
								</tr>
							</thead>
							<tbody>
								{% for task in tasks %}
									<tr class="task-row">
										<td class="fw-medium">
											{{ task.title }}
										</td>
										<td class="d-none d-sm-table-cell">
											<span title="{{ task.description }}">
												{{ task.description ? (task.description|length > 50 ? task.description|slice(0, 50) ~ '...' : task.description) : 'N/A' }}
											</span>
										</td>
										<td class="d-none d-lg-table-cell">{{ task.dueDate ? task.dueDate|date('d/m/Y') : 'Non définie' }}</td>
										<td>
											<span class="badge bg-{{ task.status == 'completed' ? 'success' : (task.status == 'in_progress' ? 'warning' : 'secondary') }}">
												{{ task.statusLabel }}
											</span>
										</td>
										<td>
											{% if task.priority == 'high' %}
												<span class="badge bg-danger">
													Haute
												</span>
											{% elseif task.priority == 'medium' %}
												<span class="badge bg-warning text-dark">
													Moyenne
												</span>
											{% else %}
												<span class="badge bg-info text-dark">
													Basse
												</span>
											{% endif %}
										</td>
										<td>
											<div class="d-flex flex-column flex-md-row justify-content-center gap-1">
												<a href="{{ path('task_edit', {id: task.id}) }}" class="btn btn-sm btn-warning mb-1 mb-md-0" title="Modifier">
													<i class="fas fa-edit"></i>
												</a>
												<button type="button" class="btn btn-sm btn-danger delete-task-btn" data-bs-toggle="modal" data-bs-target="#deleteTaskModal" data-task-id="{{ task.id }}" data-task-title="{{ task.title }}" data-csrf-token="{{ csrf_token('delete' ~ task.id) }}" title="Supprimer">
													<i class="fas fa-trash"></i>
												</button>
											</div>
										</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			{% endif %}
		</div>

		{# CONTENEUR POUR LES BOUTONS MOBILES #}
		<div class="d-sm-none d-flex justify-content-center gap-2 mb-4">
			{% if project %}
				<div class="dropdown">
					<button class="btn btn-outline-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
						<i class="fas fa-plus me-1"></i>
						Ajout rapide
					</button>
					<div class="dropdown-menu dropdown-menu-quick-add p-3" style="min-width: 300px;">
						<form id="quickAddFormMobile" method="post" action="{{ project ? path('task_quick_add', {id: project.id}) : '#' }}">
							<input type="hidden" name="_token" value="{{ csrf_token('quick-add') }}">
							<div class="mb-2">
								<input type="text" name="title" class="form-control" placeholder="Titre de la tâche" required>
							</div>
							<button type="submit" class="btn btn-success btn-sm w-100">
								<i class="fas fa-plus me-1"></i>Ajouter
							</button>
						</form>
					</div>
				</div>
			{% endif %}
			<a href="{{ path('task_new', project ? {project: project.id} : {}) }}" class="btn btn-success">
				<i class="fas fa-plus me-1"></i>Nouvelle tâche
			</a>
		</div>


		{# Modal de confirmation de suppression (pour index) #}
		<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header border-0">
						<h5 class="modal-title" id="deleteTaskModalLabel">
							<i class="fas fa-exclamation-triangle text-danger me-2"></i>
							Confirmer la suppression
						</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<p>
							Êtes-vous sûr de vouloir supprimer la tâche
							<strong id="taskToDeleteTitle"></strong>
							?
						</p>
						<div class="alert alert-warning">
							<i class="fas fa-exclamation-triangle me-2"></i>
							<strong>Attention :</strong>
							Cette action est irréversible.
						</div>
					</div>
					<div class="modal-footer border-0">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
						<form method="post" id="deleteTaskForm">
							<input type="hidden" name="_token">
							<button type="submit" class="btn btn-danger">
								<i class="fas fa-trash me-2"></i>Supprimer
							</button>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}

	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const deleteModalElement = document.getElementById('deleteTaskModal');
			if (deleteModalElement) {
				const deleteModal = new bootstrap.Modal(deleteModalElement);
				const deleteForm = document.getElementById('deleteTaskForm');
				const taskTitleElement = document.getElementById('taskToDeleteTitle');
				const tokenInput = deleteForm.querySelector('input[name="_token"]');

				document.querySelectorAll('.delete-task-btn').forEach(button => {
					button.addEventListener('click', function (event) {
						event.preventDefault();
						event.stopPropagation();

						const taskId = this.getAttribute('data-task-id');
						const taskTitle = this.getAttribute('data-task-title');
						const csrfToken = this.getAttribute('data-csrf-token');

						if (taskTitleElement) {
							taskTitleElement.textContent = taskTitle;
						}

						if (deleteForm) {
							const deletePath = "{{ path('task_delete', {id: 'TASK_ID'}) }}";
							deleteForm.action = deletePath.replace('TASK_ID', taskId);
						}

						if (tokenInput) {
							tokenInput.value = csrfToken;
						}

						deleteModal.show();
					});
				});
			}

			const quickAddForms = document.querySelectorAll('#quickAddForm, #quickAddFormMobile');

			quickAddForms.forEach(form => {
				form.addEventListener('submit', function (event) {
					event.preventDefault();
					const button = this.querySelector('button[type="submit"]');
					button.disabled = true;
					button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Ajout...';

					const formData = new FormData(this);
					const url = this.action;

					fetch(url, {
						method: 'POST',
						body: formData,
						headers: {
							'X-Requested-With': 'XMLHttpRequest'
						}
					}).then(response => response.json()).then(data => {
						if (data.success) {
							window.location.reload();
						} else {
							alert('Erreur: ' + data.message);
						}
					}).catch(error => {
						console.error('Erreur:', error);
						alert('Une erreur s\'est produite. Veuillez réessayer.');
					}).finally(() => {
						button.disabled = false;
						button.innerHTML = '<i class="fas fa-plus me-1"></i>Ajouter';
						form.reset();
					});
				});
			});
		});
	</script>
{% endblock %}