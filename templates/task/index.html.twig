{% extends 'base.html.twig' %}

{% block title %}
	{% if project %}
		T√¢ches de
		{{ project.title }}
		- TaskFlow
	{% else %}
		Mes T√¢ches - TaskFlow
	{% endif %}
{% endblock %}

{% block body %}
	<div class="container-fluid">
		<div class="row mb-4">
			<div class="col-12">
				<div class="d-flex justify-content-between align-items-center flex-wrap">
					<div class="mb-2 mb-md-0">
						{% if project %}
							<h1 class="h3 mb-1">T√¢ches de
								{{ project.title }}</h1>
							<p class="text-muted mb-0">{{ project.title }}
								compte
								{{ project.tasksCount }}
								t√¢ches ({{ project.completedTasksCount }}
								termin√©es)</p>
						{% else %}
							<h1 class="h3 mb-1">Toutes mes t√¢ches</h1>
							<p class="text-muted mb-0">Retrouvez toutes vos t√¢ches ici</p>
						{% endif %}
					</div>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-12">
				{% if tasks is empty %}
					<div class="text-center py-5">
						<div class="mb-4">
							<i class="fas fa-check-double fa-5x text-success"></i>
						</div>
						{% if project %}
							<h4 class="mb-3">Toutes les t√¢ches du projet ont √©t√© termin√©es ! üéâ</h4>
							<p class="text-muted mb-4">Bravo ! Ce projet est termin√©. Vous pouvez en ajouter d'autres depuis votre tableau de bord.</p>
							<a href="{{ path('task_new', {project: project.id}) }}" class="btn btn-primary">
								<i class="fas fa-plus me-2"></i>Ajouter une nouvelle t√¢che
							</a>
						{% else %}
							<h4 class="mb-3">Aucune t√¢che pour le moment</h4>
							<p class="text-muted mb-4">Cr√©ez votre premi√®re t√¢che pour commencer √† organiser votre travail.</p>
							<a href="{{ path('task_new') }}" class="btn btn-primary">
								<i class="fas fa-plus me-2"></i>Cr√©er une nouvelle t√¢che
							</a>
						{% endif %}
					</div>
				{% else %}
					{# Vue Tableau pour les grands √©crans #}
					<div class="d-none d-md-block">
						<div class="card border-0 shadow-sm">
							<div class="card-body">
								<div class="table-responsive">
									<table class="table table-hover align-middle mb-0">
										<thead>
											<tr>
												<th>Titre</th>
												{% if not project %}
													<th>Projet</th>
												{% endif %}
												<th>Responsable</th>
												<th>Priorit√©</th>
												<th>Date limite</th>
												<th>Statut</th>
												<th class="d-none d-sm-table-cell text-end">Actions</th>
											</tr>
										</thead>
										<tbody>
											{% for task in tasks %}
												<tr class="task-row">
													<td data-label="Titre">
														{{ task.title }}
													</td>
													{% if not project %}
														<td data-label="Projet">
															<span class="text-muted">
																<i class="fas fa-folder me-1"></i>
																{{ task.project.title }}
															</span>
														</td>
													{% endif %}
													<td data-label="Responsable">
														{% if task.assignee %}
															{{ task.assignee.fullName }}
														{% else %}
															<span class="text-muted fst-italic">Non assign√©</span>
														{% endif %}
													</td>
													<td data-label="Priorit√©">
														{% if task.priority == 'high' %}
															<span class="badge bg-danger">Haute</span>
														{% elseif task.priority == 'medium' %}
															<span class="badge bg-warning text-dark">Moyenne</span>
														{% else %}
															<span class="badge bg-info text-dark">Basse</span>
														{% endif %}
													</td>
													<td data-label="Date limite">
														{% if task.dueDate %}
															<span class="text-muted">{{ task.dueDate|date('d/m/Y') }}</span>
														{% else %}
															<span class="text-muted fst-italic">Non d√©finie</span>
														{% endif %}
													</td>
													<td data-label="Statut">
														<span class="badge bg-{{ task.status == 'completed' ?
															'success' : (task.status == 'in_progress' ? 'warning' : 'secondary') }}">{{ task.statusLabel }}</span>
													</td>
													<td data-label="Actions" class="text-end">
														<div class="d-flex justify-content-end align-items-center gap-2">
															<a href="{{ path('task_show', {id: task.id}) }}" class="btn btn-sm btn-outline-info" title="Voir les d√©tails">
																<i class="fas fa-eye"></i>
															</a>

															{% if task.assignee == app.user or task.project.owner == app.user %}
																<a href="{{ path('task_edit', {id: task.id}) }}" class="btn btn-sm btn-outline-warning" title="Modifier la t√¢che">
																	<i class="fas fa-edit"></i>
																</a>
															{% endif %}

															{% if task.assignee == app.user or task.project.owner == app.user %}
																<form method="post" action="{{ path('task_toggle_status', {id: task.id}) }}" class="d-inline">
																	<input type="hidden" name="_token" value="{{ csrf_token('toggle-status' ~ task.id) }}">
																	<button type="submit" class="btn btn-sm btn-outline-secondary" title="Actualiser le statut">
																		<i class="fas fa-sync"></i>
																	</button>
																</form>
															{% endif %}

															{% if task.project.owner == app.user %}
																<button type="button" class="btn btn-sm btn-outline-danger delete-task-btn" data-bs-toggle="modal" data-bs-target="#deleteTaskModal" data-task-id="{{ task.id }}" data-task-title="{{ task.title }}" title="Supprimer la t√¢che">
																	<i class="fas fa-trash"></i>
																</button>
															{% endif %}
														</div>
													</td>
												</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>

								{# Pagination #}
								{% if pages is defined and pages > 1 %}
									<nav aria-label="Page navigation" class="mt-4">
										<ul class="pagination justify-content-center">
											<li class="page-item {{ currentPage == 1 ?
												'disabled' : '' }}">
												<a class="page-link" href="{{ path('task_index', {project: project ? project.id : null, page: currentPage - 1}) }}" aria-label="Previous">
													<span aria-hidden="true">&laquo;</span>
												</a>
											</li>
											{% for page in 1..pages %}
												<li class="page-item {{ currentPage == page ?
													'active' : '' }}">
													<a class="page-link" href="{{ path('task_index', {project: project ? project.id : null, page: page}) }}">{{ page }}</a>
												</li>
											{% endfor %}
											<li class="page-item {{ currentPage == pages ?
												'disabled' : '' }}">
												<a class="page-link" href="{{ path('task_index', {project: project ? project.id : null, page: currentPage + 1}) }}" aria-label="Next">
													<span aria-hidden="true">&raquo;</span>
												</a>
											</li>
										</ul>
									</nav>
								{% endif %}
							</div>
						</div>
					</div>

					{# Vue Cartes pour les petits √©crans #}
					<div class="d-md-none">
						{% for task in tasks %}
							<div class="card mb-3 shadow-sm border-0">
								<div class="card-body">
									<h5 class="card-title fw-bold">
										{{ task.title }}
									</h5>
									<ul class="list-unstyled mb-0 small text-muted">
										{% if not project %}
											<li class="mb-1">
												<strong class="text-dark">Projet :</strong>
												<span class="text-muted">
													<i class="fas fa-folder me-1"></i>
													{{ task.project.title }}
												</span>
											</li>
										{% endif %}
										<li class="mb-1">
											<strong class="text-dark">Responsable :</strong>
											{% if task.assignee %}
												{{ task.assignee.fullName }}
											{% else %}
												<span class="fst-italic">Non assign√©</span>
											{% endif %}
										</li>
										<li class="mb-1">
											<strong class="text-dark">Priorit√© :</strong>
											{% if task.priority == 'high' %}
												<span class="badge bg-danger">Haute</span>
											{% elseif task.priority == 'medium' %}
												<span class="badge bg-warning text-dark">Moyenne</span>
											{% else %}
												<span class="badge bg-info text-dark">Basse</span>
											{% endif %}
										</li>
										<li class="mb-1">
											<strong class="text-dark">Date limite :</strong>
											{% if task.dueDate %}
												{{ task.dueDate|date('d/m/Y') }}
											{% else %}
												<span class="fst-italic">Non d√©finie</span>
											{% endif %}
										</li>
										<li>
											<strong class="text-dark">Statut :</strong>
											<span class="badge bg-{{ task.status == 'completed' ?
												'success' : (task.status == 'in_progress' ? 'warning' : 'secondary') }}">{{ task.statusLabel }}</span>
										</li>
									</ul>
									<div class="d-flex justify-content-end align-items-center gap-2 mt-3">
										<a href="{{ path('task_show', {id: task.id}) }}" class="btn btn-sm btn-outline-info btn-icon" title="Voir les d√©tails">
											<i class="fas fa-eye"></i>
										</a>

										{% if task.assignee == app.user or task.project.owner == app.user %}
											<a href="{{ path('task_edit', {id: task.id}) }}" class="btn btn-sm btn-outline-warning btn-icon" title="Modifier la t√¢che">
												<i class="fas fa-edit"></i>
											</a>
											<form method="post" action="{{ path('task_toggle_status', {id: task.id}) }}" class="d-inline">
												<input type="hidden" name="_token" value="{{ csrf_token('toggle-status' ~ task.id) }}">
												<button type="submit" class="btn btn-sm btn-outline-secondary btn-icon" title="Actualiser le statut">
													<i class="fas fa-sync"></i>
												</button>
											</form>
										{% endif %}

										{% if task.project.owner == app.user %}
											<button type="button" class="btn btn-sm btn-outline-danger btn-icon" data-bs-toggle="modal" data-bs-target="#deleteTaskModal" data-task-id="{{ task.id }}" data-task-title="{{ task.title }}" title="Supprimer la t√¢che">
												<i class="fas fa-trash"></i>
											</button>
										{% endif %}
									</div>
								</div>
							</div>
						{% endfor %}
					</div>
				{% endif %}
			</div>
		</div>
	</div>

	<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="deleteTaskModalLabel">
						<i class="fas fa-exclamation-triangle text-danger me-2"></i>
						Confirmer la suppression
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p>√ätes-vous s√ªr de vouloir supprimer la t√¢che
						<strong id="taskTitlePlaceholder"></strong>
						?</p>
					<div class="alert alert-warning">
						<i class="fas fa-exclamation-triangle me-2"></i>
						<strong>Attention :</strong>
						Cette action est irr√©versible.
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
					<form method="post" id="deleteTaskForm" class="d-inline">
						<input type="hidden" name="_token" id="deleteTaskToken">
						<button type="submit" class="btn btn-danger">
							<i class="fas fa-trash me-2"></i>Supprimer d√©finitivement
						</button>
					</form>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const deleteTaskModal = new bootstrap.Modal(document.getElementById('deleteTaskModal'));
			const taskTitleElement = document.getElementById('taskTitlePlaceholder');
			const deleteTaskForm = document.getElementById('deleteTaskForm');
			const deleteTaskTokenInput = document.getElementById('deleteTaskToken');
			const deleteButtons = document.querySelectorAll('.delete-task-btn');

			deleteButtons.forEach(button => {
				button.addEventListener('click', function (event) {
					const taskId = this.getAttribute('data-task-id');
					const taskTitle = this.getAttribute('data-task-title');
					const csrfToken = this.getAttribute('data-token');

					if (taskTitleElement) {
						taskTitleElement.textContent = taskTitle;
					}

					if (deleteTaskForm) {
						const deletePath = "{{ path('task_delete', {id: 'TASK_ID'}) }}";
						deleteTaskForm.action = deletePath.replace('TASK_ID', taskId);
					}

					if (deleteTaskTokenInput) {
						deleteTaskTokenInput.value = csrfToken;
					}

					deleteTaskModal.show();
				});
			});
		});
	</script>
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		/* Styles pour rendre le tableau responsive en mode "carte" */
		@media screen and(max-width: 767px) {
			.table-responsive .table thead {
				display: none;
			}

			.table-responsive .table tbody,
			.table-responsive .table tr,
			.table-responsive .table td {
				display: block;
				width: 100%;
			}

			.table-responsive .table tr {
				margin-bottom: 1rem;
				border: 1px solid #dee2e6;
				border-radius: 0.375rem;
			}

			.table-responsive .table td {
				text-align: right;
				padding-left: 50%;
				position: relative;
				border: none;
				border-bottom: 1px solid #f0f0f0;
			}

			.table-responsive .table tr td:last-child {
				border-bottom: none;
			}

			.table-responsive .table td::before {
				content: attr(data-label);
				position: absolute;
				left: 10px;
				width: calc(50% - 20px);
				text-align: left;
				font-weight: bold;
				white-space: nowrap;
			}

			/* Mise √† jour des styles pour les boutons d'action en mode mobile */
			.table-responsive .table td[data-label="Actions"] {
				text-align: center;
				padding: 15px 10px 10px;
			}

			.table-responsive .table td[data-label="Actions"]::before {
				content: "";
			}

			.table-responsive .table td[data-label="Actions"] .d-flex {
				justify-content: center !important;
			}

			/* Nouveaux styles pour corriger l'alignement vertical des ic√¥nes */
			.btn-sm i.fas {
				vertical-align: middle;
			}
		}

		.btn-icon {
			width: 38px;
			height: 38px;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 0;
		}

		.project-title {
			font-size: 2rem;
		}
	</style>
{% endblock %}