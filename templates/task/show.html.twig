{% extends 'base.html.twig' %}

{% block title %}
	{{ task.title }}
	- TaskFlow
{% endblock %}

{% block body %}
	<div class="container-fluid px-2 px-md-3">
		<div class="pb-5 mb-5 pb-lg-0 mb-lg-0">
			<div class="row mb-4">
				<div class="col-12">
					<div class="d-flex justify-content-between align-items-start">
						<div class="flex-grow-1 me-2">
							<h1 class="h3 mb-2">{{ task.title }}</h1>
							{% if task.isOverdue and not task.isCompleted %}
								<div class="d-flex gap-3 align-items-center mb-3">
									<span class="badge bg-danger fs-6">
										<i class="fas fa-exclamation-triangle me-1"></i>En retard
									</span>
								</div>
							{% endif %}
							<div class="d-flex gap-3 text-muted">
								<small>
									<i class="fas fa-calendar-plus me-1"></i>
									Créée le
									{{ task.createdAt|date('d/m/Y à H:i') }}
								</small>
								{% if task.updatedAt %}
									<small>
										<i class="fas fa-edit me-1"></i>
										Mise à jour le
										{{ task.updatedAt|date('d/m/Y à H:i') }}
									</small>
								{% endif %}
								{% if task.completedAt %}
									<small>
										<i class="fas fa-check-circle me-1 text-success"></i>
										Terminée le
										{{ task.completedAt|date('d/m/Y à H:i') }}
									</small>
								{% endif %}
							</div>
						</div>

						{# Boutons desktop #}
						<div class="d-none d-lg-flex gap-2">
							<a href="{{ path('task_edit', {id: task.id}) }}" class="btn btn-primary">
								<i class="fas fa-edit me-2"></i>Modifier
							</a>
							<form method="post" action="{{ path('task_toggle_status', {id: task.id}) }}" class="d-inline">
								<input type="hidden" name="_token" value="{{ csrf_token('toggle-status' ~ task.id) }}">
								<button type="submit" class="btn btn-outline-secondary" title="Actualiser la tâche">
									<i class="fas fa-sync me-2"></i>Actualiser
								</button>
							</form>
							{% if isOwner %}
								<button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
									<i class="fas fa-trash me-2"></i>Supprimer
								</button>
							{% endif %}
						</div>

						{# Boutons mobile #}
						<div class="d-lg-none d-flex gap-2">
							<a href="{{ path('task_edit', {id: task.id}) }}" class="btn btn-primary btn-sm btn-icon">
								<i class="fas fa-edit"></i>
							</a>
							<form method="post" action="{{ path('task_toggle_status', {id: task.id}) }}" class="d-inline">
								<input type="hidden" name="_token" value="{{ csrf_token('toggle-status' ~ task.id) }}">
								<button type="submit" class="btn btn-outline-secondary btn-sm btn-icon">
									<i class="fas fa-sync"></i>
								</button>
							</form>
							{% if isOwner %}
								<button type="button" class="btn btn-danger btn-sm btn-icon" data-bs-toggle="modal" data-bs-target="#deleteModal">
									<i class="fas fa-trash"></i>
								</button>
							{% endif %}
						</div>
					</div>
				</div>
			</div>

			<div class="row">
				<div
					class="col-lg-8">
					{# Description de la tâche #}
					<div class="card border-0 shadow-sm mb-4">
						<div class="card-header bg-white">
							<h5 class="card-title mb-0">
								<i class="fas fa-align-left me-2 text-primary"></i>Description de la tâche
							</h5>
						</div>
						<div class="card-body">
							{% if task.description %}
								<p class="mb-0">{{ task.description|nl2br }}</p>
							{% else %}
								<p class="text-muted mb-0">Aucune description n'a été ajoutée à cette tâche.</p>
							{% endif %}
						</div>
					</div>

					{# Projet associé #}
					<div class="card border-0 shadow-sm">
						<div class="card-header bg-white">
							<h5 class="card-title mb-0">
								<i class="fas fa-folder me-2 text-primary"></i>Projet associé
							</h5>
						</div>
						<div class="card-body">
							<div class="d-flex align-items-center justify-content-between mb-3">
								<h6 class="mb-0 fs-4">{{ task.project.title }}</h6>
								<a href="{{ path('project_show', {id: task.project.id}) }}" class="btn btn-outline-primary btn-sm">
									<i class="fas fa-external-link-alt me-1"></i>Voir
								</a>
							</div>
							{% if task.project.description %}
								<div class="bg-light rounded p-3">
									<h6 class="text-dark mb-2">
										<i class="fas fa-info-circle me-2 text-primary"></i>
										Description du projet
									</h6>
									<p class="mb-0 text-muted">{{ task.project.description|nl2br }}</p>
								</div>
							{% endif %}
						</div>
					</div>
				</div>

				{# Colonne droite #}
				<div
					class="col-lg-4">
					{# États de la tâche #}
					<div class="card border-0 shadow-sm mb-4">
						<div class="card-header bg-white">
							<h6 class="card-title mb-0">
								<i class="fas fa-info-circle me-2 text-primary"></i>États de la tâche
							</h6>
						</div>
						<div class="card-body">
							<div class="d-flex justify-content-between mb-2">
								<small class="text-muted">Statut :</small>
								<span class="badge bg-{{ task.status == 'completed' ? 'success' : (task.status == 'in_progress' ? 'warning' : 'secondary') }}">
									{{ task.statusLabel }}
								</span>
							</div>
							<div class="d-flex justify-content-between mb-2">
								<small class="text-muted">Priorité :</small>
								{% if task.priority == 'high' %}
									<span class="badge bg-danger">Haute</span>
								{% elseif task.priority == 'medium' %}
									<span class="badge bg-warning text-dark">Moyenne</span>
								{% else %}
									<span class="badge bg-info text-dark">Basse</span>
								{% endif %}
							</div>
							<div class="d-flex justify-content-between">
								<small class="text-muted">Date limite :</small>
								<small class="text-muted">{{ task.dueDate ? task.dueDate|date('d/m/Y') : 'Non définie' }}</small>
							</div>
						</div>
					</div>

					{# Responsable #}
					<div class="card border-0 shadow-sm">
						<div class="card-header bg-white">
							<h6 class="card-title mb-0">
								<i class="fas fa-user-circle me-2 text-primary"></i>Responsable
							</h6>
						</div>
						<div class="card-body text-center">
							{% if task.assignee %}
								<div class="d-flex flex-column align-items-center">
									<div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center mb-2" style="width: 64px; height: 64px;">
										<span class="text-primary fw-bold fs-4">
											{{ task.assignee.firstName|first }}{{ task.assignee.lastName|first }}
										</span>
									</div>
									<h5 class="mb-0">{{ task.assignee.fullName }}</h5>
									<p class="text-muted mb-0">Responsable de la tâche</p>
								</div>
							{% else %}
								<div class="d-flex flex-column align-items-center">
									<div class="bg-secondary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center mb-2" style="width: 64px; height: 64px;">
										<i class="fas fa-user text-secondary fs-4"></i>
									</div>
									<h5 class="mb-0">Non attribué</h5>
									<p class="text-muted mb-0">Cette tâche n'a pas de responsable</p>
								</div>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	{# Modal suppression #}
	<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						<i class="fas fa-exclamation-triangle text-danger me-2"></i>
						Confirmer la suppression
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<p>Êtes-vous sûr de vouloir supprimer la tâche
						<strong>"{{ task.title }}"</strong>
						?</p>
					<div class="alert alert-warning">
						<i class="fas fa-exclamation-triangle me-2"></i>
						<strong>Attention :</strong>
						Cette action est irréversible.
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
					<form method="post" action="{{ path('task_delete', {id: task.id}) }}" class="d-inline">
						<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ task.id) }}">
						<button type="submit" class="btn btn-danger">
							<i class="fas fa-trash me-2"></i>Supprimer définitivement
						</button>
					</form>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

