<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>
			{% block title %}TaskFlow - Gestion de tÃ¢ches collaboratives
			{% endblock %}
		</title>
		<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>ðŸ“‹</text></svg>">

		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
		<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

		{% block stylesheets %}
			<link rel="stylesheet" href="{{ asset('styles/app.css') }}">
		{% endblock %}
	</head>

	<body>
		<nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
			<div class="container-fluid">
				<div class="d-flex d-lg-none navbar-header-mobile">
					<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
						<span class="navbar-toggler-icon"></span>
					</button>

					<a class="navbar-brand" href="{{ path('app_home') }}">
						ðŸ“‹ TaskFlow
					</a>

					{% if app.user %}
						<div class="navbar-toggler-notifications">
							<button class="notification-bell-btn" type="button" data-bs-toggle="modal" data-bs-target="#notificationModal">
								<span class="notification-icon-wrapper">
									<i class="fas fa-bell"></i>
									<span class="badge bg-danger notification-badge" id="notification-count"></span>
								</span>
							</button>
						</div>
					{% endif %}
				</div>

				<div class="collapse navbar-collapse" id="navbarNav">
					<ul class="navbar-nav me-auto">
						<li class="nav-item d-lg-block d-none">
							<a class="navbar-brand" href="{{ path('app_home') }}">
								ðŸ“‹ TaskFlow
							</a>
						</li>
						{% if app.user %}
							<li class="nav-item d-lg-none"><hr class="dropdown-divider"></li>
							<li class="nav-item">
								<a class="nav-link" href="{{ path('app_dashboard') }}">
									<i class="fas fa-tachometer-alt"></i>
									Tableau de bord
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" href="{{ path('project_index') }}">
									<i class="fas fa-folder"></i>
									Mes Projets
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" href="{{ path('task_index') }}">
									<i class="fas fa-tasks"></i>
									Mes TÃ¢ches
								</a>
							</li>

							<li class="nav-item d-lg-none"><hr class="dropdown-divider"></li>
							<li class="nav-item d-lg-none">
								<a class="nav-link" href="{{ path('user_profile') }}">
									<i class="fas fa-user-edit"></i>
									Mon Profil
								</a>
							</li>
							{% if is_granted('ROLE_ADMIN') %}
								<li class="nav-item d-lg-none">
									<a class="nav-link" href="{{ path('admin_dashboard') }}">
										<i class="fas fa-cogs"></i>
										Administration
									</a>
								</li>
							{% endif %}
							<li class="nav-item d-lg-none">
								<a class="nav-link" href="{{ path('app_logout') }}">
									<i class="fas fa-sign-out-alt"></i>
									DÃ©connexion
								</a>
							</li>
						{% else %}
							{# DÃ©placÃ© ici pour les mobiles #}
							<li class="nav-item d-lg-none"><hr class="dropdown-divider"></li>
							<li class="nav-item d-lg-none">
								<a class="nav-link" href="{{ path('app_login') }}">
									<i class="fas fa-sign-in-alt"></i>
									Connexion
								</a>
							</li>
							<li class="nav-item d-lg-none">
								<a class="nav-link" href="{{ path('app_register') }}">
									<i class="fas fa-user-plus"></i>
									Inscription
								</a>
							</li>
						{% endif %}
					</ul>

					<ul class="navbar-nav align-items-center">
						{% if app.user %}
							<li class="nav-item d-none d-lg-block">
								<a class="nav-link" href="{{ path('user_profile') }}">
									<i class="fas fa-user-edit"></i>
									Mon Profil
								</a>
							</li>
							{% if is_granted('ROLE_ADMIN') %}
								<li class="nav-item d-none d-lg-block">
									<a class="nav-link" href="{{ path('admin_dashboard') }}">
										<i class="fas fa-cogs"></i>
										Administration
									</a>
								</li>
							{% endif %}

							<li class="nav-item dropdown d-none d-lg-block notification-desktop">
								<a class="nav-link" href="#" id="notificationDropdownDesktop" role="button" data-bs-toggle="dropdown" aria-expanded="false">
									<span class="notification-icon-wrapper">
										<i class="fas fa-bell"></i>
										<span class="badge bg-danger notification-badge" id="notification-count-desktop"></span>
									</span>
									Notifications
								</a>

								<ul class="dropdown-menu dropdown-menu-end notification-dropdown" id="notification-list-desktop" aria-labelledby="notificationDropdownDesktop"></ul>
							</li>

							<li class="nav-item d-none d-lg-block">
								<a class="nav-link" href="{{ path('app_logout') }}">
									<i class="fas fa-sign-out-alt"></i>
									DÃ©connexion
								</a>
							</li>
						{% else %}
							{# Reste ici pour les desktops #}
							<li class="nav-item d-none d-lg-block">
								<a class="nav-link" href="{{ path('app_login') }}">
									<i class="fas fa-sign-in-alt"></i>
									Connexion
								</a>
							</li>
							<li class="nav-item d-none d-lg-block">
								<a class="nav-link" href="{{ path('app_register') }}">
									<i class="fas fa-user-plus"></i>
									Inscription
								</a>
							</li>
						{% endif %}
					</ul>
				</div>
			</div>
		</nav>

		<div class="main-content">
			<div class="container-fluid py-4">
				{% for type, messages in app.flashes %}
					{% for message in messages %}
						<div class="alert alert-{{ type == 'error' ? 'danger' : type }} alert-dismissible fade show" role="alert">
							<i class="fas fa-{{ type == 'success' ? 'check-circle' : (type == 'error' ? 'exclamation-triangle' : 'info-circle') }}"></i>
							{{ message }}
							<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
						</div>
					{% endfor %}
				{% endfor %}

				{% block body %}{% endblock %}
			</div>
		</div>

		<footer class="mt-5 py-4 text-center text-muted">
			<div class="container">
				<div class="row">
					<div class="col-md-6">
						<p>&copy;
							{{ 'now'|date('Y') }}
							TaskFlow - Application de gestion de tÃ¢ches</p>
					</div>
					<div class="col-md-6">
						<div class="d-flex justify-content-center gap-3">
							<a href="{{ path('legal_terms') }}" class="text-muted text-decoration-none">CGU</a>
							<a href="{{ path('legal_privacy') }}" class="text-muted text-decoration-none">ConfidentialitÃ©</a>
							<a href="{{ path('legal_gdpr') }}" class="text-muted text-decoration-none">RGPD</a>
							<a href="{{ path('legal_cookies') }}" class="text-muted text-decoration-none">Cookies</a>
						</div>
					</div>
				</div>
				<small>DÃ©veloppÃ© avec Symfony</small>
			</div>
		</footer>

		<div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="notificationModalLabel">Mes Notifications</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body"></div>
					<div class="modal-footer">
						<a href="{{ path('notification_index') }}" class="btn btn-outline-primary w-100">Voir toutes les notifications</a>
					</div>
				</div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

		{% block javascripts %}
			<script>
				// Auto-hide alerts
document.addEventListener('DOMContentLoaded', function () {
const alerts = document.querySelectorAll('.alert:not(.alert-danger)');
alerts.forEach(function (alert) {
setTimeout(function () {
const bsAlert = new bootstrap.Alert(alert);
bsAlert.close();
}, 5000);
});
// --- SCRIPT POUR LES NOTIFICATIONS ---
const notificationCountEl = document.getElementById('notification-count');
const notificationCountElDesktop = document.getElementById('notification-count-desktop');
const notificationListElDesktop = document.getElementById('notification-list-desktop');
const notificationModal = document.getElementById('notificationModal');
const notificationModalBody = document.querySelector('#notificationModal .modal-body');
const unreadCountUrl = "{{ path('api_notification_unread_count') }}";
const recentNotificationsUrl = "{{ path('api_notification_recent') }}?limit=5";
// Met Ã  jour le compteur de notifications
const updateUnreadCount = () => {
fetch(unreadCountUrl).then(response => response.json()).then(data => {
if (data.count > 0) {
if (notificationCountEl) {
notificationCountEl.innerText = data.count;
notificationCountEl.style.display = 'flex';
}
if (notificationCountElDesktop) {
notificationCountElDesktop.innerText = data.count;
notificationCountElDesktop.style.display = 'flex';
}
} else {
if (notificationCountEl) {
notificationCountEl.style.display = 'none';
}
if (notificationCountElDesktop) {
notificationCountElDesktop.style.display = 'none';
}
}
});
};

// Charge les notifications rÃ©centes
const loadRecentNotifications = (containerElement, isModal = false) => {
containerElement.innerHTML = '<p class="text-center text-muted my-4">Chargement...</p>';
fetch(recentNotificationsUrl).then(response => response.json()).then(data => {
containerElement.innerHTML = '';

if (data.length === 0) {
containerElement.innerHTML = '<p class="text-center text-muted my-4">Aucune nouvelle notification</p>';
} else {
const listGroup = document.createElement('div');
listGroup.className = isModal ? 'list-group list-group-flush' : 'list-group';

data.forEach(notif => {
const item = document.createElement('a');
item.href = notif.read_url;
item.className = 'list-group-item list-group-item-action d-flex align-items-start notification-item';
if (!notif.is_read) {
item.classList.add('unread');
}

item.innerHTML = `
																		<i class="${
notif.icon
} ${
notif.color_class
} mt-1 me-3"></i>
																		<div>
																			<div class="small">${
notif.message
}</div>
																			<small class="text-muted">${
notif.time_ago
}</small>
																		</div>
																	`;
listGroup.appendChild(item);
});
containerElement.appendChild(listGroup);
}

// RÃ©injecter le bouton "Voir toutes" pour desktop
if (!isModal) {
const divider = document.createElement('li');
divider.innerHTML = '<hr class="dropdown-divider">';
const linkContainer = document.createElement('li');
const link = document.createElement('a');
link.href = "{{ path('notification_index') }}";
link.className = "dropdown-item text-center";
link.textContent = "Voir toutes les notifications";
linkContainer.appendChild(link);

containerElement.appendChild(divider);
containerElement.appendChild(linkContainer);
}
});
};
// Mettre Ã  jour au chargement
updateUnreadCount();
// Charger les notifications dans la modale mobile
if (notificationModal) {
notificationModal.addEventListener('show.bs.modal', function () {
loadRecentNotifications(notificationModalBody, true);
});
}

// Charger les notifications dans le dropdown desktop
const notificationDropdownDesktop = document.getElementById('notificationDropdownDesktop');
if (notificationDropdownDesktop) {
notificationDropdownDesktop.addEventListener('show.bs.dropdown', function () {
loadRecentNotifications(notificationListElDesktop);
});
}

// Mettre Ã  jour le compteur toutes les minutes
setInterval(updateUnreadCount, 60000);
});
			</script>
		{% endblock %}
	</body>
</html>
