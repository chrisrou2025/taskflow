{% extends 'base.html.twig' %}

{% block title %}
	{{ project.title }} - TaskFlow
{% endblock %}

{% block body %}
	<div class="container-fluid px-2 px-md-3">
		<div class="pb-2 mb-3">
			<div class="row g-2">
				<div class="col-12">
					<div class="d-flex justify-content-between align-items-start">
						<div class="flex-grow-1 me-2">
							<div class="d-flex align-items-center mb-1">
								<h1 class="h4 h3-md mb-0 text-truncate me-2">{{ project.title }}</h1>
								{# Badges de rôle #}
								{% if project.owner == app.user %}
									<span class="badge bg-success">
										<i class="fas fa-crown me-1"></i>Propriétaire
									</span>
								{% elseif project.hasCollaborator(app.user) %}
									<span class="badge bg-info">
										<i class="fas fa-users me-1"></i>Collaborateur
									</span>
								{% endif %}
							</div>
							<div class="d-flex gap-3 text-muted small mb-2">
								<span>
									<i class="fas fa-calendar-plus me-1"></i>
									Créé le {{ project.createdAt|date('d/m/Y') }}
								</span>
								{% if project.updatedAt %}
									<span>
										<i class="fas fa-edit me-1"></i>
										Modifié le {{ project.updatedAt|date('d/m/Y') }}
									</span>
								{% endif %}
							</div>
							{% if project.description %}
								{# Version desktop : description complète #}
								<div class="d-none d-md-block" style="max-width: 50%;">
									<p class="text-muted mb-2 small">{{ project.description }}</p>
								</div>
								{# Version mobile : description tronquée #}
								<p class="text-muted mb-2 small d-md-none">
									{{ project.description|length > 60 ? 
									project.description|slice(0, 60) ~ '...' : project.description }}
								</p>
							{% endif %}
						</div>
						
						{# Actions mobiles avec permissions #}
						<div class="d-md-none d-flex gap-2">
							{% if is_granted('PROJECT_EDIT', project) %}
								<a href="{{ path('task_new', {'project': project.id}) }}" 
								   class="btn btn-primary btn-sm btn-icon" title="Nouvelle tâche">
									<i class="fas fa-plus"></i>
								</a>
							{% endif %}
							{% if is_granted('PROJECT_EDIT', project) %}
								<a href="{{ path('project_edit', {id: project.id}) }}" 
								   class="btn btn-warning btn-sm btn-icon" title="Modifier">
									<i class="fas fa-edit"></i>
								</a>
							{% endif %}
							{% if is_granted('PROJECT_DELETE', project) %}
								<a href="#" class="btn btn-danger btn-sm btn-icon" 
								   data-bs-toggle="modal" data-bs-target="#deleteProjectModal" title="Supprimer">
									<i class="fas fa-trash"></i>
								</a>
							{% endif %}
						</div>
						
						{# Actions desktop avec permissions #}
						<div class="d-none d-md-flex gap-2">
							{% if is_granted('PROJECT_EDIT', project) %}
								<a href="{{ path('task_new', {'project': project.id}) }}" 
								   class="btn btn-primary btn-sm">
									<i class="fas fa-plus me-1"></i>Nouvelle tâche
								</a>
							{% endif %}
							{% if is_granted('PROJECT_EDIT', project) %}
								<a href="{{ path('project_edit', {id: project.id}) }}" 
								   class="btn btn-warning btn-sm">
									<i class="fas fa-edit me-1"></i>Modifier
								</a>
							{% endif %}
							{% if is_granted('PROJECT_DELETE', project) %}
								<a href="#" class="btn btn-danger btn-sm" 
								   data-bs-toggle="modal" data-bs-target="#deleteProjectModal">
									<i class="fas fa-trash me-1"></i>Supprimer
								</a>
							{% endif %}
							{% if not is_granted('PROJECT_EDIT', project) and project.hasCollaborator(app.user) %}
								<div class="alert alert-info py-2 px-3 mb-0 small">
									<i class="fas fa-info-circle me-1"></i>
									Vous êtes collaborateur - vous pouvez gérer vos tâches assignées
								</div>
							{% endif %}
						</div>
					</div>
				</div>
			</div>

			{# Barre de progression générale du projet #}
			<div class="row g-2 mt-2">
				<div class="col-12">
					<div class="card border-0 bg-light">
						<div class="card-body p-3">
							<div class="d-flex justify-content-between align-items-center mb-2">
								<small class="text-muted fw-semibold">Progression globale du projet</small>
								<small class="text-muted">{{ project.progressPercentage }}%</small>
							</div>
							<div class="progress" style="height: 8px;">
								<div class="progress-bar bg-success" role="progressbar" 
								     style="width: {{ project.progressPercentage }}%;" 
								     aria-valuenow="{{ project.progressPercentage }}" 
								     aria-valuemin="0" aria-valuemax="100"></div>
							</div>
							<div class="row text-center mt-2">
								<div class="col-3">
									<small class="d-block fw-bold">{{ project.tasksCount }}</small>
									<small class="text-muted">Total des tâches</small>
								</div>
								<div class="col-3">
									<small class="d-block fw-bold text-success">{{ project.completedTasksCount }}</small>
									<small class="text-muted">Tâches terminées</small>
								</div>
								<div class="col-3">
									<small class="d-block fw-bold text-warning">{{ project.inProgressTasksCount }}</small>
									<small class="text-muted">Tâches en cours</small>
								</div>
								<div class="col-3">
									<small class="d-block fw-bold text-info">{{ project.tasksCount - project.completedTasksCount - project.inProgressTasksCount }}</small>
									<small class="text-muted">Tâches à faire</small>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			{# Section Collaborateurs filtrée #}
			{% set collaborators = project.collaborators|filter(c => c != project.owner) %}
			{% if collaborators|length > 0 %}
				<div class="row g-2 mt-2">
					<div class="col-12">
						<div class="card border-0 bg-primary bg-opacity-10">
							<div class="card-body p-3">
								<h6 class="mb-2">
									<i class="fas fa-users me-2 text-primary"></i>
									Collaborateurs invités ({{ collaborators|length }})
								</h6>
								<div class="d-flex flex-wrap gap-2">
									{% for collaborator in collaborators %}
										<div class="d-flex align-items-center bg-white rounded-pill px-3 py-1 shadow-sm">
											<div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2" 
											     style="width: 24px; height: 24px;">
												<small class="text-primary fw-bold">{{ collaborator.firstName|first }}{{ collaborator.lastName|first }}</small>
											</div>
											<small class="text-dark fw-medium">{{ collaborator.fullName }}</small>
										</div>
									{% endfor %}
								</div>
							</div>
						</div>
					</div>
				</div>
			{% endif %}
		</div>

		<div class="row">
			<div class="col-12">
				{% if project.tasks is empty %}
					{# État vide optimisé mobile #}
					<div class="text-center py-5">
						<div class="mb-3">
							<i class="fas fa-clipboard-list fa-4x text-muted"></i>
						</div>
						<h5 class="mb-3">Aucune tâche</h5>
						<p class="text-muted mb-4 px-3">
							{% if is_granted('PROJECT_EDIT', project) %}
								Commencez par ajouter une tâche pour organiser votre travail.
							{% else %}
								Ce projet n'a pas encore de tâches. Seul le propriétaire peut en créer.
							{% endif %}
						</p>
						{% if is_granted('PROJECT_EDIT', project) %}
							<a href="{{ path('task_new', {'project': project.id}) }}" class="btn btn-primary">
								<i class="fas fa-plus me-2"></i>Ajouter une tâche
							</a>
						{% endif %}
					</div>
				{% else %}

					{# Tableau pour les écrans desktop #}
					<div class="d-none d-md-block">
						<div class="d-flex justify-content-between align-items-center mb-3">
							<h2 class="h4 mb-0">Tâches du projet</h2>
						</div>
						<div class="table-responsive">
							<table class="table table-hover align-middle">
								<thead class="table-light">
									<tr>
										<th>Titre</th>
										<th>Responsable</th>
										<th>Priorité</th>
										<th>Date limite</th>
										<th>Statut</th>
										<th class="text-end">Actions</th>
									</tr>
								</thead>
								<tbody>
									{% for task in project.tasks %}
										<tr class="{{ task.assignee == app.user ? 'table-info' : '' }}">
											<td>
												{{ task.title }}
												{% if task.assignee == app.user %}
													<i class="fas fa-user text-info ms-1" title="Votre tâche"></i>
												{% endif %}
											</td>
											<td>
												{% if task.assignee %}
													<div class="d-flex align-items-center">
														<div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2" 
														     style="width: 32px; height: 32px;">
															<small class="text-primary fw-bold">{{ task.assignee.firstName|first }}{{ task.assignee.lastName|first }}</small>
														</div>
														<span>{{ task.assignee.fullName }}</span>
													</div>
												{% else %}
													<span class="text-muted fst-italic">Non assigné</span>
												{% endif %}
											</td>
											<td>
												{% if task.priority == 'high' %}
													<span class="badge bg-danger">Haute</span>
												{% elseif task.priority == 'medium' %}
													<span class="badge bg-warning text-dark">Moyenne</span>
												{% else %}
													<span class="badge bg-info text-dark">Basse</span>
												{% endif %}
											</td>
											<td>
												{% if task.dueDate %}
													<span class="text-muted">{{ task.dueDate|date('d/m/Y') }}</span>
													{% if task.isOverdue and not task.isCompleted %}
														<i class="fas fa-exclamation-triangle text-danger ms-1" title="En retard"></i>
													{% endif %}
												{% else %}
													<span class="text-muted fst-italic">Non définie</span>
												{% endif %}
											</td>
											<td>
												<span class="badge bg-{{ task.status == 'completed' ? 
												'success' : (task.status == 'in_progress' ? 'warning' : 'secondary') }}">{{ task.statusLabel }}</span>
											</td>
											<td class="text-end">
												<div class="d-flex justify-content-end align-items-center gap-2">
													{% if is_granted('TASK_VIEW', task) %}
														<a href="{{ path('task_show', {id: task.id}) }}" 
														   class="btn btn-sm btn-outline-info" title="Voir les détails">
															<i class="fas fa-eye"></i>
														</a>
													{% endif %}
													{% if is_granted('TASK_EDIT', task) %}
														<a href="{{ path('task_edit', {id: task.id}) }}" 
														   class="btn btn-sm btn-outline-warning" title="Modifier la tâche">
															<i class="fas fa-edit"></i>
														</a>
													{% endif %}
													{% if is_granted('TASK_MANAGE', task) %}
														<form method="post" action="{{ path('task_toggle_status', {id: task.id}) }}" class="d-inline">
															<input type="hidden" name="_token" value="{{ csrf_token('toggle-status' ~ task.id) }}">
															<button type="submit" class="btn btn-sm btn-outline-secondary" title="Actualiser le statut">
																<i class="fas fa-sync"></i>
															</button>
														</form>
													{% endif %}
													{% if is_granted('TASK_DELETE', task) %}
														<button type="button" class="btn btn-sm btn-outline-danger delete-task-btn" 
														        data-bs-toggle="modal" data-bs-target="#deleteTaskModal" 
														        data-task-id="{{ task.id }}" data-task-title="{{ task.title }}" 
														        title="Supprimer la tâche">
															<i class="fas fa-trash"></i>
														</button>
													{% endif %}
												</div>
											</td>
										</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
					</div>

					{# Liste de cartes pour les écrans mobiles #}
					<div class="d-md-none">
						<div class="d-flex justify-content-between align-items-center mb-3">
							<h2 class="h4 mb-0">Tâches</h2>
						</div>
						{% for task in project.tasks %}
							<div class="card mb-3 shadow-sm border-0 {{ task.assignee == app.user ? 'border-info' : '' }}">
								<div class="card-body">
									<h5 class="card-title fw-bold">
										{{ task.title }}
										{% if task.assignee == app.user %}
											<i class="fas fa-user text-info ms-1" title="Votre tâche"></i>
										{% endif %}
										{% if task.isOverdue and not task.isCompleted %}
											<i class="fas fa-exclamation-triangle text-danger ms-1" title="En retard"></i>
										{% endif %}
									</h5>
									<ul class="list-unstyled mb-0 small text-muted">
										<li class="mb-1">
											<strong class="text-dark">Responsable :</strong>
											{% if task.assignee %}
												<div class="d-inline-flex align-items-center">
													<div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-1" 
													     style="width: 20px; height: 20px;">
														<small class="text-primary fw-bold" style="font-size: 0.7rem;">{{ task.assignee.firstName|first }}{{ task.assignee.lastName|first }}</small>
													</div>
													{{ task.assignee.fullName }}
												</div>
											{% else %}
												<span class="fst-italic">Non assigné</span>
											{% endif %}
										</li>
										<li class="mb-1">
											<strong class="text-dark">Priorité :</strong>
											{% if task.priority == 'high' %}
												<span class="badge bg-danger">Haute</span>
											{% elseif task.priority == 'medium' %}
												<span class="badge bg-warning text-dark">Moyenne</span>
											{% else %}
												<span class="badge bg-info text-dark">Basse</span>
											{% endif %}
										</li>
										<li class="mb-1">
											<strong class="text-dark">Date limite :</strong>
											{% if task.dueDate %}
												{{ task.dueDate|date('d/m/Y') }}
											{% else %}
												<span class="fst-italic">Non définie</span>
											{% endif %}
										</li>
										<li>
											<strong class="text-dark">Statut :</strong>
											<span class="badge bg-{{ task.status == 'completed' ? 
											'success' : (task.status == 'in_progress' ? 'warning' : 'secondary') }}">{{ task.statusLabel }}</span>
										</li>
									</ul>
									<div class="d-flex justify-content-end align-items-center gap-2 mt-3">
										{% if is_granted('TASK_VIEW', task) %}
											<a href="{{ path('task_show', {id: task.id}) }}" 
											   class="btn btn-sm btn-outline-info btn-icon" title="Voir les détails">
												<i class="fas fa-eye"></i>
											</a>
										{% endif %}
										{% if is_granted('TASK_EDIT', task) %}
											<a href="{{ path('task_edit', {id: task.id}) }}" 
											   class="btn btn-sm btn-outline-warning btn-icon" title="Modifier la tâche">
												<i class="fas fa-edit"></i>
											</a>
										{% endif %}
										{% if is_granted('TASK_MANAGE', task) %}
											<form method="post" action="{{ path('task_toggle_status', {id: task.id}) }}" class="d-inline">
												<input type="hidden" name="_token" value="{{ csrf_token('toggle-status' ~ task.id) }}">
												<button type="submit" class="btn btn-sm btn-outline-secondary btn-icon" title="Actualiser le statut">
													<i class="fas fa-sync"></i>
												</button>
											</form>
										{% endif %}
										{% if is_granted('TASK_DELETE', task) %}
											<button type="button" class="btn btn-sm btn-outline-danger btn-icon" 
											        data-bs-toggle="modal" data-bs-target="#deleteTaskModal" 
											        data-task-id="{{ task.id }}" data-task-title="{{ task.title }}" 
											        title="Supprimer la tâche">
												<i class="fas fa-trash"></i>
											</button>
										{% endif %}
									</div>
								</div>
							</div>
						{% endfor %}
					</div>
				{% endif %}
			</div>
		</div>
	</div>

	{# MODALES - Uniquement si autorisé #}
	{% if project.tasks|length > 0 and is_granted('PROJECT_EDIT', project) %}
		<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header border-0 pb-0">
						<h5 class="modal-title text-danger">
							<i class="fas fa-exclamation-triangle me-2"></i>
							Confirmer la suppression
						</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<p class="mb-0">Êtes-vous sûr de vouloir supprimer la tâche
							<strong id="taskTitle"></strong> ?</p>
					</div>
					<div class="modal-footer border-0 pt-0">
						<button type="button" class="btn btn-secondary flex-grow-1" data-bs-dismiss="modal">Annuler</button>
						<form method="post" action="#" id="deleteTaskForm" class="flex-grow-1">
							<input type="hidden" name="_token" id="deleteToken" value="">
							<button type="submit" class="btn btn-danger w-100">
								<i class="fas fa-trash me-2"></i>Supprimer
							</button>
						</form>
					</div>
				</div>
			</div>
		</div>
	{% endif %}

	{% if is_granted('PROJECT_DELETE', project) %}
		<div class="modal fade" id="deleteProjectModal" tabindex="-1">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header border-0 pb-0">
						<h5 class="modal-title text-danger">
							<i class="fas fa-exclamation-triangle me-2"></i>
							Confirmer la suppression
						</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<p class="mb-3">Êtes-vous sûr de vouloir supprimer le projet
							<strong>"{{ project.title }}"</strong> ?</p>
						<div class="alert alert-warning mb-0">
							<div class="d-flex align-items-start">
								<i class="fas fa-exclamation-triangle me-2 mt-1 flex-shrink-0"></i>
								<div>
									<strong>Attention :</strong>
									Cette action supprimera définitivement le projet et toutes ses tâches 
									({{ project.tasksCount }} tâche{{ project.tasksCount > 1 ? 's' : '' }}).
								</div>
							</div>
						</div>
					</div>
					<div class="modal-footer border-0 pt-0">
						<button type="button" class="btn btn-secondary flex-grow-1" data-bs-dismiss="modal">Annuler</button>
						<form method="post" action="{{ path('project_delete', {id: project.id}) }}" class="flex-grow-1">
							<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ project.id) }}">
							<button type="submit" class="btn btn-danger w-100">
								<i class="fas fa-trash me-2"></i>Supprimer
							</button>
						</form>
					</div>
				</div>
			</div>
		</div>
	{% endif %}

	{# Script JavaScript pour gérer la modale dynamique #}
	{% if project.tasks|length > 0 and is_granted('PROJECT_EDIT', project) %}
		<script>
			document.addEventListener('DOMContentLoaded', function () {
				const deleteTaskModal = document.getElementById('deleteTaskModal');
				const taskTitleElement = document.getElementById('taskTitle');
				const deleteTaskForm = document.getElementById('deleteTaskForm');
				const deleteTokenInput = document.getElementById('deleteToken');

				// Pré-génération des tokens CSRF pour toutes les tâches
				const csrfTokens = {
					{% for task in project.tasks %}
						'{{ task.id }}': '{{ csrf_token('delete' ~ task.id) }}'{{ not loop.last ? ',' : '' }}
					{% endfor %}
				};

				// Écouteur d'événement pour tous les boutons de suppression de tâche
				deleteTaskModal.addEventListener('show.bs.modal', function (event) {
					// Récupération du bouton qui a déclenché la modale
					const button = event.relatedTarget;

					// Extraction des données du bouton
					const taskId = button.getAttribute('data-task-id');
					const taskTitle = button.getAttribute('data-task-title');

					// Mise à jour du contenu de la modale
					taskTitleElement.textContent = '"' + taskTitle + '"';

					// Construction de l'URL de suppression
					const deleteUrl = '{{ path('task_delete', {id: '__TASK_ID__'}) }}'.replace('__TASK_ID__', taskId);
					deleteTaskForm.action = deleteUrl;

					// Utilisation du token CSRF pré-généré
					const token = csrfTokens[taskId];
					if (token) {
						deleteTokenInput.value = token;
					} else {
						console.error('Token CSRF introuvable pour la tâche ID:', taskId);
						// Optionnel : désactiver le bouton de suppression si pas de token
						const submitButton = deleteTaskForm.querySelector('button[type="submit"]');
						if (submitButton) {
							submitButton.disabled = true;
						}
					}
				});
			});
		</script>
	{% endif %}
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		.btn-icon {
			width: 38px;
			height: 38px;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 0;
		}

		.project-title {
			font-size: 2rem;
		}
	</style>
{% endblock %}