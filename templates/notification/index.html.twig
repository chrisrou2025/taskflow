{% extends 'base.html.twig' %}

{% block title %}Mes Notifications{% endblock %}

{% block body %}
	<div class="container-fluid px-2 px-md-3">
		<!-- En-tête harmonisé -->
		<div class="row mb-4">
			<div class="col-12">
				<div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center">
					<div>
						<h1 class="h3 h2-md mb-2">
							<i class="fas fa-bell me-2 text-primary"></i>
							Mes Notifications
						</h1>
						<p class="text-muted mb-0">
							Restez informé de l'activité sur vos projets
						</p>
					</div>
					<!-- Actions rapides utilisant VOS routes existantes -->
					<div class="d-flex flex-column flex-sm-row gap-2 mt-3 mt-sm-0 align-items-start align-items-sm-center">
						<!-- Première ligne mobile : "Tout marquer lu" -->
						{% if notifications|filter(n => not n.isRead)|length > 0 %}
							<form method="post" action="{{ path('notification_mark_all_read') }}" class="d-inline order-1 order-sm-1">
								<input type="hidden" name="_token" value="{{ csrf_token('mark-all-read') }}">
								<button class="btn btn-sm btn-outline-success">
									<i class="fas fa-check-double me-1"></i>
									<span class="d-none d-sm-inline">Tout marquer lu</span>
									<span class="d-sm-none">Marquer tout lu</span>
								</button>
							</form>
						{% endif %}
						
						<!-- Deuxième ligne mobile : "Gérer les demandes" et "Nettoyer lues" côte à côte -->
						<div class="d-flex gap-2 order-2 order-sm-0 align-self-stretch align-self-sm-center">
							<!-- Nouveau bouton "Gérer les demandes" -->
							<a href="{{ path('collaboration_requests') }}" class="btn btn-sm btn-outline-info">
								<i class="fas fa-cog me-1"></i>
								<span class="d-none d-sm-inline">Gérer les demandes</span>
								<span class="d-sm-none">Gérer les demandes</span>
							</a>
							
							{% if notifications|filter(n => n.isRead)|length > 0 %}
								<form method="post" action="{{ path('notification_delete_read') }}" class="d-inline" onsubmit="return confirm('Supprimer toutes les notifications lues ?')">
									<input type="hidden" name="_token" value="{{ csrf_token('delete-read-notifications') }}">
									<button class="btn btn-sm btn-outline-warning">
										<i class="fas fa-broom me-1"></i>
										<span class="d-none d-sm-inline">Nettoyer lues</span>
										<span class="d-sm-none">Nettoyer les lues</span>
									</button>
								</form>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Contenu principal -->
		<div class="row">
			<div class="col-12">
				{% if notifications is empty %}
					<!-- État vide harmonisé -->
					<div class="text-center py-5">
						<div class="mb-3">
							<i class="fas fa-bell-slash fa-4x text-muted"></i>
						</div>
						<h5 class="mb-3">Aucune notification</h5>
						<p class="text-muted mb-4 px-3">
							Vous n'avez aucune notification pour le moment.<br>
							Les nouvelles activités sur vos projets apparaîtront ici.
						</p>
						<div class="d-flex flex-column flex-sm-row gap-2 justify-content-center">
							<a href="{{ path('app_dashboard') }}" class="btn btn-outline-primary">
								<i class="fas fa-tachometer-alt me-2"></i>Tableau de bord
							</a>
							<a href="{{ path('project_index') }}" class="btn btn-outline-secondary">
								<i class="fas fa-folder me-2"></i>Mes projets
							</a>
						</div>
					</div>
				{% else %}
					<!-- Filtres harmonisés -->
					<div class="card border-0 bg-light mb-3">
						<div class="card-body p-3">
							<div class="d-flex flex-wrap gap-2 align-items-center">
								<span class="text-muted small me-2">Filtrer :</span>
								<button class="filter-btn btn btn-sm btn-outline-secondary active" data-filter="all">
									Toutes ({{ notifications|length }})
								</button>
								<button class="filter-btn btn btn-sm btn-outline-warning" data-filter="unread">
									Non lues ({{ notifications|filter(n => not n.isRead)|length }})
								</button>
								<button class="filter-btn btn btn-sm btn-outline-success" data-filter="collaboration_request">
									Invitations ({{ notifications|filter(n => n.type == 'collaboration_request')|length }})
								</button>
								<button class="filter-btn btn btn-sm btn-outline-info" data-filter="task_assigned">
									Tâches ({{ notifications|filter(n => n.type == 'task_assigned')|length }})
								</button>
							</div>
						</div>
					</div>

					<!-- Version desktop - tableau harmonisé SANS colonne Type -->
					<div class="d-none d-lg-block notification-table">
						<div class="card border-0 shadow-sm">
							<div class="card-body p-0">
								<div class="table-responsive">
									<table class="table table-hover align-middle mb-0">
										<thead class="table-light">
											<tr>
												<th>Notification</th>
												<th>Date</th>
												<th>Statut</th>
												<th class="text-end">Actions</th>
											</tr>
										</thead>
										<tbody>
											{% for notification in notifications %}
												<tr class="notification-item {{ not notification.isRead ? 'table-info' : '' }}" 
													data-type="{{ notification.type }}" 
													data-read="{{ notification.isRead ? 'true' : 'false' }}">
													<td>
														<div class="d-flex align-items-start">
															<div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3 flex-shrink-0" style="width: 40px; height: 40px;">
																<i class="{{ notification.icon }} text-primary"></i>
															</div>
															<div class="flex-grow-1">
																<h6 class="mb-1 fw-bold {{ not notification.isRead ? 'text-dark' : 'text-muted' }}">
																	{{ notification.title }}
																	{% if not notification.isRead %}
																		<span class="badge bg-primary ms-2">Nouveau</span>
																	{% endif %}
																</h6>
																<p class="mb-1 text-muted small">{{ notification.message }}</p>
																<!-- Métadonnées -->
																<div class="d-flex flex-wrap gap-3 small text-muted">
																	{% if notification.sender %}
																		<span>
																			<i class="fas fa-user me-1"></i>
																			{{ notification.sender.fullName }}
																		</span>
																	{% endif %}
																	{% if notification.project %}
																		<span>
																			<i class="fas fa-folder me-1"></i>
																			{{ notification.project.title }}
																		</span>
																	{% endif %}
																	{% if notification.task %}
																		<span>
																			<i class="fas fa-tasks me-1"></i>
																			{{ notification.task.title }}
																		</span>
																	{% endif %}
																</div>
															</div>
														</div>
													</td>
													<td>
														<span class="text-muted small">{{ notification.timeAgo }}</span>
													</td>
													<td>
														{% if notification.isRead %}
															<span class="badge bg-secondary">Lu</span>
														{% else %}
															<span class="badge bg-warning text-dark">Non lu</span>
														{% endif %}
													</td>
													<td class="text-end">
														<div class="d-flex justify-content-end align-items-center gap-1">
															{% if notification.actionUrl %}
																<a href="{{ path('notification_read', {id: notification.id}) }}" class="btn btn-sm btn-outline-info" title="Voir les détails">
																	<i class="fas fa-eye"></i>
																	<span class="d-none d-xl-inline ms-1">Voir</span>
																</a>
															{% endif %}

															<form method="post" action="{{ path('notification_delete', {id: notification.id}) }}" onsubmit="return confirm('Supprimer cette notification ?');" class="d-inline">
																<input type="hidden" name="_token" value="{{ csrf_token('delete-notification-' ~ notification.id) }}">
																<button class="btn btn-sm btn-outline-danger" title="Supprimer">
																	<i class="fas fa-trash"></i>
																	<span class="d-none d-xl-inline ms-1">Supprimer</span>
																</button>
															</form>
														</div>
													</td>
												</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>

					<!-- Version mobile - cartes harmonisées SANS ligne Type -->
					<div class="d-lg-none">
						{% for notification in notifications %}
							<div class="card mb-3 shadow-sm border-0 notification-item {{ not notification.isRead ? 'border-info' : '' }}" 
								 data-type="{{ notification.type }}" 
								 data-read="{{ notification.isRead ? 'true' : 'false' }}">
								<div class="card-body">
									<div class="d-flex align-items-start mb-3">
										<div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3 flex-shrink-0" style="width: 48px; height: 48px;">
											<i class="{{ notification.icon }} text-primary fa-lg"></i>
										</div>
										<div class="flex-grow-1 min-width-0">
											<h6 class="fw-bold mb-1 {{ not notification.isRead ? 'text-dark' : 'text-muted' }}">
												{{ notification.title }}
												{% if not notification.isRead %}
													<span class="badge bg-primary ms-2">Nouveau</span>
												{% endif %}
											</h6>
											<p class="text-muted small mb-2">{{ notification.message }}</p>
										</div>
									</div>

									<!-- Informations détaillées SANS Type -->
									<ul class="list-unstyled mb-0 small text-muted">
										<li class="mb-1">
											<strong class="text-dark">Date :</strong>
											{{ notification.timeAgo }}
										</li>
										{% if notification.sender %}
											<li class="mb-1">
												<strong class="text-dark">De :</strong>
												{{ notification.sender.fullName }}
											</li>
										{% endif %}
										{% if notification.project %}
											<li class="mb-1">
												<strong class="text-dark">Projet :</strong>
												{{ notification.project.title }}
											</li>
										{% endif %}
										{% if notification.task %}
											<li class="mb-1">
												<strong class="text-dark">Tâche :</strong>
												{{ notification.task.title }}
											</li>
										{% endif %}
										<li>
											<strong class="text-dark">Statut :</strong>
											{% if notification.isRead %}
												<span class="badge bg-secondary">Lu</span>
											{% else %}
												<span class="badge bg-warning text-dark">Non lu</span>
											{% endif %}
										</li>
									</ul>

									<!-- Actions harmonisées -->
									<div class="d-flex justify-content-end align-items-center gap-2 mt-3">
										{% if notification.actionUrl %}
											<a href="{{ path('notification_read', {id: notification.id}) }}" class="btn btn-sm btn-outline-info" title="Voir les détails">
												<i class="fas fa-eye"></i>
											</a>
										{% endif %}

										<form method="post" action="{{ path('notification_delete', {id: notification.id}) }}" onsubmit="return confirm('Supprimer cette notification ?');" class="d-inline">
											<input type="hidden" name="_token" value="{{ csrf_token('delete-notification-' ~ notification.id) }}">
											<button class="btn btn-sm btn-outline-danger" title="Supprimer">
												<i class="fas fa-trash"></i>
											</button>
										</form>
									</div>
								</div>
							</div>
						{% endfor %}
					</div>
				{% endif %}
			</div>
		</div>

		<!-- Pagination harmonisée -->
		{% if total_pages > 1 %}
			<nav class="mt-4" aria-label="Navigation des notifications">
				<ul class="pagination justify-content-center">
					<li class="page-item {{ not has_previous ? 'disabled' }}">
						<a class="page-link" href="{{ path('notification_index', {page: previous_page}) }}">
							<i class="fas fa-chevron-left me-1"></i>
							<span class="d-none d-sm-inline">Précédent</span>
						</a>
					</li>

					{% for i in 1..total_pages %}
						{% if i == current_page %}
							<li class="page-item active">
								<span class="page-link">{{ i }}</span>
							</li>
						{% elseif i == 1 or i == total_pages or (i >= current_page - 2 and i <= current_page + 2) %}
							<li class="page-item">
								<a class="page-link" href="{{ path('notification_index', {page: i}) }}">{{ i }}</a>
							</li>
						{% elseif i == current_page - 3 or i == current_page + 3 %}
							<li class="page-item disabled">
								<span class="page-link">...</span>
							</li>
						{% endif %}
					{% endfor %}

					<li class="page-item {{ not has_next ? 'disabled' }}">
						<a class="page-link" href="{{ path('notification_index', {page: next_page}) }}">
							<span class="d-none d-sm-inline">Suivant</span>
							<i class="fas fa-chevron-right ms-1"></i>
						</a>
					</li>
				</ul>
			</nav>
		{% endif %}
	</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/notification.js') }}"></script>
{% endblock %}