{% extends 'base.html.twig' %}

{% block stylesheets %}
	{{ parent() }}
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
{% endblock %}

{% block title %}Tableau de bord - TaskFlow
{% endblock %}

{% block body %}
	{# Configuration pour le système de mise à jour du dashboard #}
	<div id="dashboard-config" data-config='{"recentTasksUrl": "{{ path('api_dashboard_recent_tasks') }}"}' style="display: none;"></div>

	<div class="container-fluid px-3 px-lg-4">
		<div class="row g-3 mb-4">
			<div class="col-6 col-lg-3">
				<div class="stats-card card border-0 bg-primary text-white h-100">
					<div class="card-body p-3 p-lg-4">
						<div class="text-center text-lg-start">
							<div class="d-lg-flex align-items-center">
								<div class="flex-grow-1">
									<h6 class="card-title mb-1 small">Projets</h6>
									<h3 class="h4 h2-lg mb-0">{{ total_projects }}</h3>
								</div>
								<div class="d-none d-lg-block ms-3">
									<i class="fas fa-folder fa-2x opacity-75"></i>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="col-6 col-lg-3">
				<div class="stats-card card border-0 bg-success text-white h-100">
					<div class="card-body p-3 p-lg-4">
						<div class="text-center text-lg-start">
							<div class="d-lg-flex align-items-center">
								<div class="flex-grow-1">
									<h6 class="card-title mb-1 small">Tâches terminées</h6>
									<h3 class="h4 h2-lg mb-0">{{ tasks_by_status.completed ?? 0 }}</h3>
								</div>
								<div class="d-none d-lg-block ms-3">
									<i class="fas fa-check-circle fa-2x opacity-75"></i>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="col-6 col-lg-3">
				<div class="stats-card card border-0 bg-warning text-white h-100">
					<div class="card-body p-3 p-lg-4">
						<div class="text-center text-lg-start">
							<div class="d-lg-flex align-items-center">
								<div class="flex-grow-1">
									<h6 class="card-title mb-1 small">Tâches en cours</h6>
									<h3 class="h4 h2-lg mb-0">{{ tasks_by_status.in_progress ?? 0 }}</h3>
								</div>
								<div class="d-none d-lg-block ms-3">
									<i class="fas fa-clock fa-2x opacity-75"></i>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="col-6 col-lg-3">
				<div class="stats-card card border-0 bg-danger text-white h-100">
					<div class="card-body p-3 p-lg-4">
						<div class="text-center text-lg-start">
							<div class="d-lg-flex align-items-center">
								<div class="flex-grow-1">
									<h6 class="card-title mb-1 small">Tâches en retard</h6>
									<h3 class="h4 h2-lg mb-0">{{ overdue_tasks|length }}</h3>
								</div>
								<div class="d-none d-lg-block ms-3">
									<i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-12 col-lg-8 mb-4">
				<div class="card border-0 shadow-sm h-100">
					<div class="card-header bg-white border-bottom">
						<div class="d-flex justify-content-between align-items-center">
							<h5 class="card-title mb-0 h6 h5-lg">
								<i class="fas fa-folder me-2 text-primary"></i>Mes projets récents
							</h5>
							<a href="{{ path('project_index') }}" class="btn btn-outline-primary btn-sm">
								<span class="d-none d-sm-inline">Voir tous</span>
								<i class="fas fa-arrow-right d-sm-none"></i>
							</a>
						</div>
					</div>
					<div class="card-body p-0">
						{% if projects is empty %}
							<div class="text-center py-4 py-lg-5">
								<i class="fas fa-folder-open fa-2x fa-3x-lg text-muted mb-3"></i>
								<h6 class="text-muted">Aucun projet pour le moment</h6>
								<p class="text-muted mb-3 small">Commencez par créer votre premier projet !</p>
								<a href="{{ path('project_new') }}" class="btn btn-primary">
									<i class="fas fa-plus me-2"></i>Créer un projet
								</a>
							</div>
						{% else %}
							<div class="d-lg-none">
								{% for project in projects %}
									<div class="card-project-mobile border-bottom">
										<div class="p-3">
											<div class="d-flex justify-content-between align-items-start mb-2">
												<div class="flex-grow-1">
													<h6 class="mb-1">{{ project.title }}</h6>
													{% if project.description %}
														<small class="text-muted d-block">{{ project.description|length > 40 ? project.description|slice(0, 40) ~ '...' : project.description }}</small>
													{% endif %}
												</div>
												<small class="text-muted ms-2">{{ project.createdAt|date('d/m') }}</small>
											</div>

											{% set progress = project.progressPercentage %}
											<div class="d-flex align-items-center mb-2">
												<div class="progress flex-grow-1 me-2" style="height: 8px;">
													<div class="progress-bar bg-{{ progress == 100 ? 'success' : (progress > 50 ? 'primary' : 'warning') }}" style="width: {{ progress }}%"></div>
												</div>
												<small class="text-muted">{{ progress }}%</small>
											</div>

											<div class="d-flex justify-content-between align-items-center">
												<span class="badge bg-light text-dark">
													{{ project.completedTasksCount }}/{{ project.tasksCount }}
												</span>
												<div class="btn-group btn-group-sm">
													<a href="{{ path('project_show', {id: project.id}) }}" class="btn btn-outline-primary btn-sm">
														<i class="fas fa-eye"></i>
													</a>
													<a href="{{ path('task_index', {project: project.id}) }}" class="btn btn-outline-success btn-sm">
														<i class="fas fa-tasks"></i>
													</a>
												</div>
											</div>
										</div>
									</div>
								{% endfor %}
							</div>

							<div class="d-none d-lg-block">
								<div class="table-responsive">
									<table class="table table-hover mb-0">
										<thead class="table-light">
											<tr>
												<th>Projet</th>
												<th>Progression</th>
												<th>Tâches</th>
												<th>Créé le</th>
												<th>Actions</th>
											</tr>
										</thead>
										<tbody>
											{% for project in projects %}
												<tr>
													<td>
														<div>
															<h6 class="mb-1">{{ project.title }}</h6>
															{% if project.description %}
																<small class="text-muted">{{ project.description|length > 50 ? project.description|slice(0, 50) ~ '...' : project.description }}</small>
															{% endif %}
														</div>
													</td>
													<td>
														{% set progress = project.progressPercentage %}
														<div class="d-flex align-items-center">
															<div class="progress flex-grow-1 me-2" style="height: 6px;">
																<div class="progress-bar bg-{{ progress == 100 ? 'success' : (progress > 50 ? 'primary' : 'warning') }}" style="width: {{ progress }}%"></div>
															</div>
															<small class="text-muted">{{ progress }}%</small>
														</div>
													</td>
													<td>
														<span class="badge bg-light text-dark">
															{{ project.completedTasksCount }}/{{ project.tasksCount }}
														</span>
													</td>
													<td>
														<small class="text-muted">{{ project.createdAt|date('d/m/Y') }}</small>
													</td>
													<td>
														<div class="btn-group btn-group-sm">
															<a href="{{ path('project_show', {id: project.id}) }}" class="btn btn-outline-primary btn-sm">
																<i class="fas fa-eye"></i>
																<span class="d-none d-lg-inline ms-1">Voir</span>
															</a>
															<a href="{{ path('task_index', {project: project.id}) }}" class="btn btn-outline-success btn-sm">
																<i class="fas fa-tasks"></i>
																<span class="d-none d-lg-inline ms-1">Tâches</span>
															</a>
														</div>
													</td>
												</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
							</div>
						{% endif %}
					</div>
				</div>
			</div>

			{# Version mobile de l'activité récente #}
			<div class="col-12 d-lg-none mt-4">
				<div class="card border-0 shadow-sm">
					<div class="card-header bg-white border-bottom">
						<h6 class="card-title mb-0">
							<i class="fas fa-clock me-2 text-primary"></i>Activité récente
						</h6>
					</div>
					<div class="card-body p-0">
						{% if recent_tasks is empty %}
							<div class="text-center py-4">
								<i class="fas fa-tasks fa-2x text-muted mb-2"></i>
								<p class="text-muted mb-0">Aucune tâche récente</p>
							</div>
						{% else %}
							<div class="list-group list-group-flush">
								{% for task in recent_tasks %}
									<div class="list-group-item">
										<div class="d-flex justify-content-between align-items-start">
											<div class="flex-grow-1">
												<h6 class="mb-1">{{ task.title }}</h6>
												<div class="d-flex flex-column">
													<small class="text-muted mb-1">
														<span class="fw-bold">Projet:</span>
														{{ task.project.title }}
													</small>
													<div class="d-flex align-items-center mb-1">
														<span class="me-1 small text-muted">Statut:</span>
														<span class="badge
																																																																																																															{% if task.status == 'todo' %}badge-todo
																																																																																																															{% elseif task.status in ['in_progress', 'en_cours'] %}badge-progress
																																																																																																															{% elseif task.status == 'completed' %}badge-completed
																																																																																																															{% else %}badge-secondary
																																																																																																															{% endif %} badge-sm">
															{{ task.statusLabel }}
														</span>
													</div>
													<div class="d-flex align-items-center">
														<span class="me-1 small text-muted">Priorité:</span>
														<span class="badge {{ task.priority == 'high' ? 'badge-priority-high' : (task.priority == 'medium' ? 'badge-priority-medium' : 'badge-priority-low') }} badge-sm">
															{{ task.priorityLabel }}
														</span>
													</div>
												</div>
											</div>
											<div class="text-end">
												<small class="text-muted">
													{{ task.updatedAt ? task.updatedAt|date('d/m H:i', timezone="Europe/Paris") : task.createdAt|date('d/m H:i', timezone="Europe/Paris") }}
												</small>
											</div>
										</div>
									</div>
								{% endfor %}
							</div>
						{% endif %}
					</div>
				</div>
			</div>

			{# Version desktop de l'activité récente #}
			<div class="col-lg-4 d-none d-lg-block">
				<div class="card border-0 shadow-sm">
					<div class="card-header bg-white border-bottom">
						<h6 class="card-title mb-0">
							<i class="fas fa-clock me-2 text-primary"></i>Activité récente
						</h6>
					</div>
					<div class="card-body p-0">
						{% if recent_tasks is empty %}
							<div class="text-center py-4">
								<i class="fas fa-tasks fa-2x text-muted mb-2"></i>
								<p class="text-muted mb-0">Aucune tâche récente</p>
							</div>
						{% else %}
							<div class="list-group list-group-flush">
								{% for task in recent_tasks %}
									<div class="list-group-item">
										<div class="d-flex justify-content-between align-items-start">
											<div class="flex-grow-1">
												<h6 class="mb-1">{{ task.title }}</h6>
												<div class="d-flex flex-column">
													<small class="text-muted mb-1">
														<span class="fw-bold">Projet:</span>
														{{ task.project.title }}
													</small>
													<div class="d-flex align-items-center mb-1">
														<span class="me-1 small text-muted">Statut:</span>
														<span class="badge
																																																																																																															{% if task.status == 'todo' %}badge-todo
																																																																																																															{% elseif task.status in ['in_progress', 'en_cours'] %}badge-progress
																																																																																																															{% elseif task.status == 'completed' %}badge-completed
																																																																																																															{% else %}badge-secondary
																																																																																																															{% endif %} badge-sm">
															{{ task.statusLabel }}
														</span>
													</div>
													<div class="d-flex align-items-center">
														<span class="me-1 small text-muted">Priorité:</span>
														<span class="badge {{ task.priority == 'high' ? 'badge-priority-high' : (task.priority == 'medium' ? 'badge-priority-medium' : 'badge-priority-low') }} badge-sm">
															{{ task.priorityLabel }}
														</span>
													</div>
												</div>
											</div>
											<div class="text-end">
												<small class="text-muted">
													{{ task.updatedAt ? task.updatedAt|date('d/m H:i', timezone="Europe/Paris") : task.createdAt|date('d/m H:i', timezone="Europe/Paris") }}
												</small>
											</div>
										</div>
									</div>
								{% endfor %}
							</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}
