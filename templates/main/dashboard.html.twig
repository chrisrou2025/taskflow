{% extends 'base.html.twig' %}

{% block title %}Tableau de bord - TaskFlow
{% endblock %}

{% block body %}
	<div
		class="container-fluid px-3 px-lg-4">
		<!-- Header du dashboard - Mobile optimis√© -->
		<div class="row mb-3 mb-lg-4">
			<div class="col-12">
				<div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
					<div>
						<h1 class="h4 h3-lg mb-2">üìä Tableau de bord</h1>
						<p class="text-muted mb-0 small">Bonjour
							{{ app.user.firstName }}
							! Voici un aper√ßu de vos projets</p>
					</div>
					<div class="w-100 w-lg-auto d-flex justify-content-end">
						<a href="{{ path('project_new') }}" class="btn btn-primary w-100" style="max-width: 200px;">
							<i class="fas fa-plus me-2"></i>Nouveau projet
						</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Statistiques principales - Mobile First Grid -->
		<div
			class="row g-3 mb-4">
			<!-- Version mobile : 2x2 grid -->
			<div class="col-6 col-lg-3">
				<div class="stats-card card border-0 bg-primary text-white h-100">
					<div class="card-body p-3 p-lg-4">
						<div class="text-center text-lg-start">
							<div class="d-lg-flex align-items-center">
								<div class="flex-grow-1">
									<div class="stats-icon d-lg-none mb-2">
										<i class="fas fa-folder fa-lg"></i>
									</div>
									<h6 class="card-title mb-1 small">Projets</h6>
									<h3 class="h4 h2-lg mb-0">{{ total_projects }}</h3>
								</div>
								<div class="d-none d-lg-block ms-3">
									<i class="fas fa-folder fa-2x opacity-75"></i>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="col-6 col-lg-3">
				<div class="stats-card card border-0 bg-success text-white h-100">
					<div class="card-body p-3 p-lg-4">
						<div class="text-center text-lg-start">
							<div class="d-lg-flex align-items-center">
								<div class="flex-grow-1">
									<div class="stats-icon d-lg-none mb-2">
										<i class="fas fa-check-circle fa-lg"></i>
									</div>
									<h6 class="card-title mb-1 small">Termin√©es</h6>
									<h3 class="h4 h2-lg mb-0">{{ tasks_by_status.completed ?? 0 }}</h3>
								</div>
								<div class="d-none d-lg-block ms-3">
									<i class="fas fa-check-circle fa-2x opacity-75"></i>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="col-6 col-lg-3">
				<div class="stats-card card border-0 bg-warning text-white h-100">
					<div class="card-body p-3 p-lg-4">
						<div class="text-center text-lg-start">
							<div class="d-lg-flex align-items-center">
								<div class="flex-grow-1">
									<div class="stats-icon d-lg-none mb-2">
										<i class="fas fa-clock fa-lg"></i>
									</div>
									<h6 class="card-title mb-1 small">En cours</h6>
									<h3 class="h4 h2-lg mb-0">{{ tasks_by_status.in_progress ?? 0 }}</h3>
								</div>
								<div class="d-none d-lg-block ms-3">
									<i class="fas fa-clock fa-2x opacity-75"></i>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="col-6 col-lg-3">
				<div class="stats-card card border-0 bg-danger text-white h-100">
					<div class="card-body p-3 p-lg-4">
						<div class="text-center text-lg-start">
							<div class="d-lg-flex align-items-center">
								<div class="flex-grow-1">
									<div class="stats-icon d-lg-none mb-2">
										<i class="fas fa-exclamation-triangle fa-lg"></i>
									</div>
									<h6 class="card-title mb-1 small">En retard</h6>
									<h3 class="h4 h2-lg mb-0">{{ overdue_tasks|length }}</h3>
								</div>
								<div class="d-none d-lg-block ms-3">
									<i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- T√¢ches en retard - Alert mobile -->
		{% if overdue_tasks is not empty %}
			<div class="row mb-4 d-lg-none">
				<div class="col-12">
					<div class="alert alert-danger d-flex align-items-center" role="alert">
						<i class="fas fa-exclamation-triangle me-2"></i>
						<div class="flex-grow-1">
							<strong>{{ overdue_tasks|length }}
								t√¢che(s) en retard</strong>
						</div>
						<button class="btn btn-sm btn-outline-danger" data-bs-toggle="collapse" data-bs-target="#overdueTasksMobile">
							<i class="fas fa-chevron-down"></i>
						</button>
					</div>
					<div class="collapse" id="overdueTasksMobile">
						<div class="card border-danger">
							<div class="list-group list-group-flush">
								{% for task in overdue_tasks|slice(0, 3) %}
									<div class="list-group-item">
										<div class="d-flex justify-content-between align-items-start">
											<div class="flex-grow-1">
												<h6 class="mb-1 small">{{ task.title }}</h6>
												<small class="text-muted">{{ task.project.title }}</small>
											</div>
											<small class="text-danger">
												<i class="fas fa-calendar-times"></i>
												{{ task.dueDate|date('d/m') }}
											</small>
										</div>
									</div>
								{% endfor %}
							</div>
						</div>
					</div>
				</div>
			</div>
		{% endif %}

		<!-- Contenu principal reorganis√© -->
		<div
			class="row">
			<!-- Projets r√©cents - Pleine largeur sur mobile -->
			<div class="col-12 col-lg-8 mb-4">
				<div class="card border-0 shadow-sm h-100">
					<div class="card-header bg-white border-bottom">
						<div class="d-flex justify-content-between align-items-center">
							<h5 class="card-title mb-0 h6 h5-lg">
								<i class="fas fa-folder me-2 text-primary"></i>Mes projets r√©cents
							</h5>
							<a href="{{ path('project_index') }}" class="btn btn-outline-primary btn-sm">
								<span class="d-none d-sm-inline">Voir tous</span>
								<i class="fas fa-arrow-right d-sm-none"></i>
							</a>
						</div>
					</div>
					<div class="card-body p-0">
						{% if projects is empty %}
							<div class="text-center py-4 py-lg-5">
								<i class="fas fa-folder-open fa-2x fa-3x-lg text-muted mb-3"></i>
								<h6 class="text-muted">Aucun projet pour le moment</h6>
								<p class="text-muted mb-3 small">Commencez par cr√©er votre premier projet !</p>
								<a href="{{ path('project_new') }}" class="btn btn-primary">
									<i class="fas fa-plus me-2"></i>Cr√©er un projet
								</a>
							</div>
						{% else %}
							<!-- Vue mobile : cards -->
							<div class="d-lg-none">
								{% for project in projects %}
									<div class="card-project-mobile border-bottom">
										<div class="p-3">
											<div class="d-flex justify-content-between align-items-start mb-2">
												<div class="flex-grow-1">
													<h6 class="mb-1">{{ project.title }}</h6>
													{% if project.description %}
														<small class="text-muted d-block">{{ project.description|length > 40 ? project.description|slice(0, 40) ~ '...' : project.description }}</small>
													{% endif %}
												</div>
												<small class="text-muted ms-2">{{ project.createdAt|date('d/m') }}</small>
											</div>

											{% set progress = project.progressPercentage %}
											<div class="d-flex align-items-center mb-2">
												<div class="progress flex-grow-1 me-2" style="height: 8px;">
													<div class="progress-bar bg-{{ progress == 100 ? 'success' : (progress > 50 ? 'primary' : 'warning') }}" style="width: {{ progress }}%"></div>
												</div>
												<small class="text-muted">{{ progress }}%</small>
											</div>

											<div class="d-flex justify-content-between align-items-center">
												<span class="badge bg-light text-dark">
													{{ project.completedTasksCount }}/{{ project.tasksCount }}
												</span>
												<div class="btn-group btn-group-sm">
													<a href="{{ path('project_show', {id: project.id}) }}" class="btn btn-outline-primary btn-sm">
														<i class="fas fa-eye"></i>
													</a>
													<a href="{{ path('task_index', {project: project.id}) }}" class="btn btn-outline-success btn-sm">
														<i class="fas fa-tasks"></i>
													</a>
												</div>
											</div>
										</div>
									</div>
								{% endfor %}
							</div>

							<!-- Vue desktop : tableau -->
							<div class="d-none d-lg-block">
								<div class="table-responsive">
									<table class="table table-hover mb-0">
										<thead class="table-light">
											<tr>
												<th>Projet</th>
												<th>Progression</th>
												<th>T√¢ches</th>
												<th>Cr√©√© le</th>
												<th>Actions</th>
											</tr>
										</thead>
										<tbody>
											{% for project in projects %}
												<tr>
													<td>
														<div>
															<h6 class="mb-1">{{ project.title }}</h6>
															{% if project.description %}
																<small class="text-muted">{{ project.description|length > 50 ? project.description|slice(0, 50) ~ '...' : project.description }}</small>
															{% endif %}
														</div>
													</td>
													<td>
														{% set progress = project.progressPercentage %}
														<div class="d-flex align-items-center">
															<div class="progress flex-grow-1 me-2" style="height: 6px;">
																<div class="progress-bar bg-{{ progress == 100 ? 'success' : (progress > 50 ? 'primary' : 'warning') }}" style="width: {{ progress }}%"></div>
															</div>
															<small class="text-muted">{{ progress }}%</small>
														</div>
													</td>
													<td>
														<span class="badge bg-light text-dark">
															{{ project.completedTasksCount }}/{{ project.tasksCount }}
														</span>
													</td>
													<td>
														<small class="text-muted">{{ project.createdAt|date('d/m/Y') }}</small>
													</td>
													<td>
														<div class="btn-group btn-group-sm">
															<a href="{{ path('project_show', {id: project.id}) }}" class="btn btn-outline-primary btn-sm">
																<i class="fas fa-eye"></i>
															</a>
															<a href="{{ path('task_index', {project: project.id}) }}" class="btn btn-outline-success btn-sm">
																<i class="fas fa-tasks"></i>
															</a>
														</div>
													</td>
												</tr>
											{% endfor %}
										</tbody>
									</table>
								</div>
							</div>
						{% endif %}
					</div>
				</div>
			</div>

			<!-- Sidebar - Hidden sur mobile, visible sur desktop -->
			<div
				class="col-lg-4 d-none d-lg-block">
				<!-- T√¢ches en retard -->
				{% if overdue_tasks is not empty %}
					<div class="card border-0 shadow-sm mb-4">
						<div class="card-header bg-danger text-white">
							<h6 class="card-title mb-0">
								<i class="fas fa-exclamation-triangle me-2"></i>T√¢ches en retard ({{ overdue_tasks|length }})
							</h6>
						</div>
						<div class="card-body p-0">
							<div class="list-group list-group-flush">
								{% for task in overdue_tasks|slice(0, 5) %}
									<div class="list-group-item">
										<div class="d-flex justify-content-between align-items-start">
											<div class="flex-grow-1">
												<h6 class="mb-1">{{ task.title }}</h6>
												<small class="text-muted">{{ task.project.title }}</small>
											</div>
											<small class="text-danger">
												<i class="fas fa-calendar-times"></i>
												{{ task.dueDate|date('d/m') }}
											</small>
										</div>
									</div>
								{% endfor %}
							</div>
							{% if overdue_tasks|length > 5 %}
								<div class="card-footer text-center">
									<small class="text-muted">{{ overdue_tasks|length - 5 }}
										autre(s) t√¢che(s) en retard</small>
								</div>
							{% endif %}
						</div>
					</div>
				{% endif %}

				<!-- T√¢ches r√©centes -->
				<div class="card border-0 shadow-sm">
					<div class="card-header bg-white border-bottom">
						<h6 class="card-title mb-0">
							<i class="fas fa-clock me-2 text-primary"></i>Activit√© r√©cente
						</h6>
					</div>
					<div class="card-body p-0">
						{% if recent_tasks is empty %}
							<div class="text-center py-4">
								<i class="fas fa-tasks fa-2x text-muted mb-2"></i>
								<p class="text-muted mb-0">Aucune t√¢che r√©cente</p>
							</div>
						{% else %}
							<div class="list-group list-group-flush">
								{% for task in recent_tasks %}
									<div class="list-group-item">
										<div class="d-flex justify-content-between align-items-start">
											<div class="flex-grow-1">
												<h6 class="mb-1">{{ task.title }}</h6>
												<div class="d-flex align-items-center">
													<small class="text-muted me-2">{{ task.project.title }}</small>
													<span class="badge badge-{{ task.status }} badge-sm">
														{{ task.statusLabel }}
													</span>
												</div>
											</div>
											<div class="text-end">
												<span class="badge bg-{{ task.priority == 'high' ? 'danger' : (task.priority == 'medium' ? 'warning' : 'secondary') }} badge-sm">
													{{ task.priorityLabel }}
												</span>
												<br>
												<small class="text-muted">{{ task.createdAt|date('d/m H:i') }}</small>
											</div>
										</div>
									</div>
								{% endfor %}
							</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>

	<style>
		/* Optimisations mobile */
		@media(max-width: 991.98px) {
			.h4-lg {
				font-size: 1.5rem;
			}
			.h3-lg {
				font-size: 1.75rem;
			}
			.h2-lg {
				font-size: 2rem;
			}
			.h5-lg {
				font-size: 1.25rem;
			}
			.h6-lg {
				font-size: 1.1rem;
			}
			.fa-3x-lg {
				font-size: 3em;
			}
			.p-lg-4 {
				padding: 1rem;
			}
			.p-lg-5 {
				padding: 1.5rem;
			}
			.py-lg-5 {
				padding-top: 1.5rem;
				padding-bottom: 1.5rem;
			}
			.py-lg-4 {
				padding-top: 1rem;
				padding-bottom: 1rem;
			}
		}

		.stats-card {
			transition: transform 0.2s ease, box-shadow 0.2s ease;
			min-height: 100px;
		}

		.stats-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
		}

		.stats-icon {
			opacity: 0.8;
		}

		.card-project-mobile {
			transition: background-color 0.2s ease;
		}

		.card-project-mobile:hover {
			background-color: rgba(0, 0, 0, 0.02);
		}

		.card-project-mobile:last-child {
			border-bottom: none !important;
		}

		.progress {
			background-color: rgba(0, 0, 0, 0.1);
		}

		.badge-todo {
			background-color: #6c757d;
		}
		.badge-progress {
			background-color: #fd7e14;
		}
		.badge-completed {
			background-color: #198754;
		}

		.table td {
			vertical-align: middle;
		}

		.list-group-item {
			border-left: none;
			border-right: none;
		}

		.list-group-item:first-child {
			border-top: none;
		}

		.list-group-item:last-child {
			border-bottom: none;
		}

		/* Am√©lioration des zones tactiles */
		@media(max-width: 768px) {
			.btn {
				min-height: 44px;
				padding: 0.625rem 1rem;
			}

			.btn-sm {
				min-height: 36px;
				padding: 0.5rem 0.75rem;
			}

			.card-body {
				padding: 1rem;
			}

			.list-group-item {
				padding: 1rem;
			}
		}

		/* Animation d'entr√©e */
		.stats-card {
			animation: fadeInUp 0.6s ease-out;
		}

		.stats-card:nth-child(2) {
			animation-delay: 0.1s;
		}
		.stats-card:nth-child(3) {
			animation-delay: 0.2s;
		}
		.stats-card:nth-child(4) {
			animation-delay: 0.3s;
		}

		@keyframes fadeInUp {
			from {
				opacity: 0;
				transform: translateY(20px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}
	</style>
{% endblock %}
