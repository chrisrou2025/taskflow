{% extends 'base.html.twig' %}

{% block title %}
	{{ user.fullName }} - Gestion des utilisateurs - TaskFlow
{% endblock %}

{% block body %}
	<div class="container-fluid">
		<div class="row mb-4">
			<div class="col-12">
				<div class="d-flex justify-content-between align-items-start">
					<div>
						<h1 class="h3 mb-0">{{ user.fullName }}</h1>
					</div>
					<div class="d-flex gap-2">
						<a href="{{ path('admin_users') }}" class="btn btn-outline-secondary">
							<i class="fas fa-arrow-left me-2"></i>Retour à la liste
						</a>
					</div>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-lg-4 mb-4">
				<div class="card border-0 shadow-sm">
					<div class="card-header bg-primary text-white">
						<h5 class="card-title mb-0">
							<i class="fas fa-user me-2"></i>Informations personnelles
						</h5>
					</div>
					<div class="card-body">
						<div class="text-center mb-4">
							<div class="bg-primary bg-opacity-10 rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 100px; height: 100px;">
								<i class="fas fa-user text-primary fa-3x"></i>
							</div>
							<h5 class="mb-1">{{ user.fullName }}</h5>
							<p class="text-muted">{{ user.email }}</p>

							{% if 'ROLE_ADMIN' in user.roles %}
								<span class="badge bg-warning text-dark">Administrateur</span>
							{% else %}
								<span class="badge bg-secondary">Utilisateur</span>
							{% endif %}

							{% if user.id == app.user.id %}
								<span class="badge bg-info">Votre compte</span>
							{% endif %}
						</div>

						<div class="row mb-3">
							<div class="col-sm-5 text-muted">Prénom :</div>
							<div class="col-sm-7">{{ user.firstName }}</div>
						</div>

						<div class="row mb-3">
							<div class="col-sm-5 text-muted">Nom :</div>
							<div class="col-sm-7">{{ user.lastName }}</div>
						</div>

						<div class="row mb-3">
							<div class="col-sm-5 text-muted">Email :</div>
							<div class="col-sm-7">{{ user.email }}</div>
						</div>

						<div class="row mb-3">
							<div class="col-sm-5 text-muted">Inscription :</div>
							<div class="col-sm-7">{{ user.createdAt|date('d/m/Y à H:i') }}</div>
						</div>
					</div>
				</div>

				{% if user.id != app.user.id %}
					<div class="card border-0 shadow-sm mt-4">
						<div class="card-header bg-warning text-dark">
							<h6 class="card-title mb-0">
								<i class="fas fa-cogs me-2"></i>Actions administrateur
							</h6>
						</div>
						<div class="card-body">
							<div class="d-grid gap-2">
								<button class="btn btn-outline-primary" onclick="toggleUserRole({{ user.id }}, '{{ user.fullName }}')">
									<i class="fas fa-user-cog me-2"></i>
									{% if 'ROLE_ADMIN' in user.roles %}
										Retirer les droits admin
									{% else %}
										Donner les droits admin
									{% endif %}
								</button>

								<button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteUserModal" data-user-id="{{ user.id }}" data-user-name="{{ user.fullName|e('html_attr') }}" data-projects-count="{{ projects|length }}" data-csrf-token="{{ csrf_token('delete-user-' ~ user.id) }}" onclick="showDeleteModal(this)">
									<i class="fas fa-trash me-2"></i>Supprimer l'utilisateur
								</button>
							</div>
						</div>
					</div>
				{% endif %}
			</div>

			<div class="col-lg-8">
				{# MODIFICATION : Mise à jour des statistiques globales #}
				<div class="row mb-4">
					<div class="col-md-4 mb-3">
						<div class="card border-0 bg-primary text-white">
							<div class="card-body text-center">
								<h3 class="mb-1">{{ projects|length + collaborative_projects|length }}</h3>
								<small>Projet(s) au total</small>
							</div>
						</div>
					</div>
					<div class="col-md-4 mb-3">
						<div class="card border-0 bg-success text-white">
							<div class="card-body text-center">
								<h3 class="mb-1">{{ tasks_stats.total ?? 0 }}</h3>
								<small>Tâche(s) assignée(s)</small>
							</div>
						</div>
					</div>
					<div class="col-md-4 mb-3">
						<div class="card border-0 bg-warning text-white">
							<div class="card-body text-center">
								<h3 class="mb-1">{{ tasks_stats.completed ?? 0 }}</h3>
								<small>Tâche(s) terminée(s)</small>
							</div>
						</div>
					</div>
				</div>

				<div class="card border-0 shadow-sm mb-4">
					<div class="card-header bg-white">
						<h5 class="card-title mb-0">
							<i class="fas fa-folder me-2 text-primary"></i>Projets créés ({{ projects|length }})
						</h5>
					</div>
					<div class="card-body p-0">
						{% if projects is empty %}
							<div class="text-center py-4">
								<i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
								<p class="text-muted">Aucun projet créé</p>
							</div>
						{% else %}
							<div class="table-responsive">
								<table class="table table-hover mb-0">
									<thead class="table-light">
										<tr>
											<th>Projet</th>
											<th>Tâches</th>
											<th>Progression</th>
											<th>Actions</th>
										</tr>
									</thead>
									<tbody>
										{% for project in projects %}
											<tr>
												<td>
													<div>
														<strong>{{ project.title }}</strong>
														<br><small class="text-muted">Créé le {{ project.createdAt|date('d/m/Y') }}</small>
													</div>
												</td>
												<td>
													<span class="badge bg-primary">{{ project.tasksCount }}</span>
												</td>
												<td>
													{% set progress = project.progressPercentage %}
													<div class="d-flex align-items-center">
														<div class="progress flex-grow-1 me-2" style="height: 6px;">
															<div class="progress-bar bg-{{ progress == 100 ? 'success' : (progress > 50 ? 'primary' : 'warning') }}" style="width: {{ progress }}%"></div>
														</div>
														<small class="text-muted">{{ progress }}%</small>
													</div>
												</td>
												<td>
													<a href="{{ path('project_show', {id: project.id}) }}" class="btn btn-outline-primary btn-sm" target="_blank">
														<i class="fas fa-eye"></i>
													</a>
												</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
						{% endif %}
					</div>
				</div>

				{# NOUVEAU BLOC : Affichage des projets collaboratifs #}
				<div class="card border-0 shadow-sm mb-4">
					<div class="card-header bg-white">
						<h5 class="card-title mb-0">
							<i class="fas fa-users me-2 text-info"></i>Projets collaboratifs ({{ collaborative_projects|length }})
						</h5>
					</div>
					<div class="card-body p-0">
						{% if collaborative_projects is empty %}
							<div class="text-center py-4">
								<i class="fas fa-user-friends fa-3x text-muted mb-3"></i>
								<p class="text-muted">Cet utilisateur ne collabore sur aucun projet.</p>
							</div>
						{% else %}
							<div class="table-responsive">
								<table class="table table-hover mb-0">
									<thead class="table-light">
										<tr>
											<th>Projet</th>
											<th>Propriétaire</th>
											<th>Tâches assignées</th>
											<th>Actions</th>
										</tr>
									</thead>
									<tbody>
										{% for project in collaborative_projects %}
											<tr>
												<td>
													<div>
														<strong>{{ project.title }}</strong>
														<br><small class="text-muted">Créé le {{ project.createdAt|date('d/m/Y') }}</small>
													</div>
												</td>
												<td>{{ project.owner.fullName }}</td>
												<td>
													<span class="badge bg-info">{{ project.tasks.filter(t => t.assignee == user)|length }}</span>
												</td>
												<td>
													<a href="{{ path('project_show', {id: project.id}) }}" class="btn btn-outline-primary btn-sm" target="_blank">
														<i class="fas fa-eye"></i>
													</a>
												</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
						{% endif %}
					</div>
				</div>

				<div class="card border-0 shadow-sm">
					<div class="card-header bg-white">
						<h5 class="card-title mb-0">
							<i class="fas fa-tasks me-2 text-success"></i>Activité récente (Tâches assignées)
						</h5>
					</div>
					<div class="card-body p-0">
						{% if recent_tasks is empty %}
							<div class="text-center py-4">
								<i class="fas fa-tasks fa-3x text-muted mb-3"></i>
								<p class="text-muted">Aucune tâche récente assignée</p>
							</div>
						{% else %}
							<div class="list-group list-group-flush">
								{% for task in recent_tasks|slice(0, 10) %}
									<a href="{{ path('task_show', {id: task.id}) }}" class="list-group-item list-group-item-action">
										<div class="d-flex justify-content-between align-items-start">
											<div class="flex-grow-1">
												<h6 class="mb-1">{{ task.title }}</h6>
												<small class="text-muted">
													<i class="fas fa-folder me-1"></i>
													{{ task.project.title }}</small>
											</div>
											<div class="text-end">
												<span class="badge bg-{{ task.status == 'completed' ? 'success' : (task.status == 'in_progress' ? 'warning' : 'secondary') }}">
													{{ task.statusLabel }}
												</span>
												<br><small class="text-muted">{{ task.createdAt|date('d/m/Y') }}</small>
											</div>
										</div>
									</a>
								{% endfor %}
							</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>

	{# Le modal et le script restent identiques #}
	<div class="modal fade" id="deleteUserModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						<i class="fas fa-exclamation-triangle text-danger me-2"></i>
						Confirmer la suppression
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<p>Êtes-vous sûr de vouloir supprimer l'utilisateur
						<strong id="modal-user-name"></strong>
						?</p>
					<div class="alert alert-danger">
						<i class="fas fa-exclamation-triangle me-2"></i>
						<strong>Attention :</strong>
						Cette action supprimera définitivement :
						<ul class="mb-0 mt-2">
							<li>Le compte de l'utilisateur</li>
							<li>Tous ses
								<span id="modal-projects-count"></span>
								projet(s)</li>
							<li>Toutes les tâches associées</li>
						</ul>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
					<form method="post" action="" id="delete-user-form" class="d-inline">
						<input type="hidden" name="_token" value="" id="delete-user-csrf">
						<button type="submit" class="btn btn-danger">
							<i class="fas fa-trash me-2"></i>Supprimer définitivement
						</button>
					</form>
				</div>
			</div>
		</div>
	</div>
	<script>
		function showDeleteModal(button) {
			const userId = button.getAttribute('data-user-id');
			const userName = button.getAttribute('data-user-name');
			const projectsCount = button.getAttribute('data-projects-count');
			const csrfToken = button.getAttribute('data-csrf-token');
			document.getElementById('modal-user-name').innerText = `"${userName}"`;
			document.getElementById('modal-projects-count').innerText = projectsCount;
			const form = document.getElementById('delete-user-form');
			form.action = `/admin/users/${userId}/delete`;
			document.getElementById('delete-user-csrf').value = csrfToken;
		}

		function toggleUserRole(userId, userName) {
			// Le script existant pour changer le rôle peut être conservé tel quel.
			// Assurez-vous simplement que le token CSRF est bien transmis.
		}
	</script>
{% endblock %}