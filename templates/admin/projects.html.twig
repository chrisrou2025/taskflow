{% extends 'base.html.twig' %}

{% block title %}Gestion des projets - Administration - TaskFlow
{% endblock %}

{% block body %}
	<div class="container-fluid">
		<div class="row mb-4">
			<div class="col-12">
				<div class="d-flex justify-content-between align-items-center">
					<div>
						<h1 class="h3 mb-2">Gestion des projets</h1>
						<p class="text-muted mb-0">{{ total_projects }}
							projet(s) au total</p>
					</div>
					<div class="d-flex gap-2">
						<a href="{{ path('admin_dashboard') }}" class="btn btn-outline-secondary">
							<i class="fas fa-arrow-left me-2"></i>Retour
						</a>
					</div>
				</div>
			</div>
		</div>

		<div class="row mb-4">
			<div class="col-12">
				<div class="card border-0 shadow-sm">
					<div class="card-body">
						<form method="get" class="row g-3 align-items-end" id="filter-form">
							<div class="col-12 col-md-4">
								<label for="search" class="form-label">Rechercher</label>
								<input type="search" class="form-control" id="search" name="search" value="{{ app.request.query.get('search') }}">
							</div>
							<div class="col-12 col-md-4">
								<label for="owner" class="form-label">Filtrer par propriétaire</label>
								<select id="owner" name="owner" class="form-select">
									<option value="">Tous les utilisateurs</option>
									{% for user in users %}
										<option value="{{ user.id }}" {{ app.request.query.get('owner') == user.id ? 'selected' : '' }}>
											{{ user.fullName }}
										</option>
									{% endfor %}
								</select>
							</div>
							<div class="col-12 col-md-4">
								<label for="sort" class="form-label">Trier par</label>
								<select id="sort" name="sort" class="form-select">
									<option value="created_at" {{ app.request.query.get('sort') == 'created_at' ? 'selected' : '' }}>Date de création</option>
									<option value="title" {{ app.request.query.get('sort') == 'title' ? 'selected' : '' }}>Titre</option>
									<option value="tasks_count" {{ app.request.query.get('sort') == 'tasks_count' ? 'selected' : '' }}>Nombre de tâches</option>
								</select>
							</div>
							<div class="col-12 d-grid d-md-block">
								<button type="submit" class="btn btn-primary">Appliquer les filtres</button>
								<a href="{{ path('admin_projects') }}" class="btn btn-outline-secondary mt-2 mt-md-0">Réinitialiser</a>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

		<div class="row mb-4">
			<div class="col-12">
				<div class="card border-0 shadow-sm">
					<div class="card-body p-0">
						{% if projects is empty %}
							<div class="p-4 text-center text-muted">
								<i class="fas fa-box-open fa-2x mb-3"></i>
								<p class="mb-0">Aucun projet trouvé avec les filtres actuels.</p>
							</div>
						{% else %}
							<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 p-3">
								{% for project in projects %}
									<div class="col">
										<div class="card h-100 shadow-sm">
											<div class="card-body">
												<h5 class="card-title">{{ project.title }}</h5>
												<p class="card-text text-muted">
													{{ project.description|length > 80 ? project.description|slice(0, 80) ~ '...' : project.description }}
												</p>
												<ul class="list-group list-group-flush mt-3">
													<li class="list-group-item d-flex justify-content-between align-items-center">
														<small class="text-muted">Propriétaire :</small>
														<strong>{{ project.owner.fullName }}</strong>
													</li>
													<li class="list-group-item d-flex justify-content-between align-items-center">
														<small class="text-muted">Tâches :</small>
														<span>
															<span class="badge bg-primary">{{ project.tasksCount }}</span>
															<small class="text-muted">{{ project.completedTasksCount }}
																terminées</small>
														</span>
													</li>
													<li class="list-group-item d-flex justify-content-between align-items-center">
														<small class="text-muted">Progression :</small>
														<div class="w-50">
															{% set progress = project.progressPercentage %}
															<div class="progress" style="height: 8px;">
																<div class="progress-bar bg-{{ progress == 100 ? 'success' : (progress > 50 ? 'primary' : 'warning') }}" style="width: {{ progress }}%"></div>
															</div>
															<small class="text-muted">{{ progress }}%</small>
														</div>
													</li>
													<li class="list-group-item d-flex justify-content-between align-items-center">
														<small class="text-muted">Créé le :</small>
														<span>{{ project.createdAt|date('d/m/Y') }}</span>
													</li>
												</ul>
											</div>
											<div class="card-footer bg-light d-flex justify-content-end gap-2">
												<a href="{{ path('project_show', {id: project.id}) }}" class="btn btn-outline-primary btn-sm" title="Voir le projet">
													<i class="fas fa-eye"></i>
												</a>
												{# CORRECTION: Ajout du token CSRF dans les attributs data #}
												<button 
													type="button" 
													class="btn btn-outline-danger btn-sm delete-project-btn" 
													data-bs-toggle="modal" 
													data-bs-target="#deleteProjectModal" 
													data-project-id="{{ project.id }}" 
													data-project-title="{{ project.title|e('html_attr') }}" 
													data-project-tasks="{{ project.tasksCount }}" 
													data-project-owner="{{ project.owner.fullName|e('html_attr') }}" 
													data-project-owner-email="{{ project.owner.email|e('html_attr') }}"
													data-csrf-token="{{ csrf_token('delete-project-' ~ project.id) }}"
													title="Supprimer le projet">
													<i class="fas fa-trash"></i>
												</button>
											</div>
										</div>
									</div>
								{% endfor %}
							</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="deleteProjectModal" tabindex="-1" aria-labelledby="deleteProjectModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="deleteProjectModalLabel">Confirmation de suppression</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<form id="delete-project-form" method="POST">
					<div class="modal-body">
						<p>Vous êtes sur le point de supprimer le projet
							<strong>
								<span id="modal-project-title"></span>
							</strong>. Cette action est irréversible et supprimera également toutes les tâches associées.
						</p>
						<p class="mb-0">
							<strong>Détails du projet :</strong>
						</p>
						<ul>
							<li>Titre :
								<span id="project-name"></span>
							</li>
							<li>Nombre de tâches :
								<span id="project-tasks"></span>
							</li>
							<li>Propriétaire :
								<span id="project-owner"></span>
								(<span id="project-owner-email"></span>)
							</li>
						</ul>
						<input type="hidden" name="_method" value="DELETE">
						<input type="hidden" name="_token" id="deleteProjectToken">
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
						<button type="submit" class="btn btn-danger">Supprimer le projet</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script>
		// CORRECTION COMPLÈTE : Gestion de la modal de suppression
		document.addEventListener('DOMContentLoaded', function() {
			const deleteModal = new bootstrap.Modal(document.getElementById('deleteProjectModal'));
			const deleteForm = document.getElementById('delete-project-form');
			const projectTitleElement = document.getElementById('modal-project-title');
			const projectNameElement = document.getElementById('project-name');
			const projectTasksElement = document.getElementById('project-tasks');
			const projectOwnerElement = document.getElementById('project-owner');
			const projectOwnerEmailElement = document.getElementById('project-owner-email');
			const tokenInput = document.getElementById('deleteProjectToken');

			document.querySelectorAll('.delete-project-btn').forEach(button => {
				button.addEventListener('click', function (e) {
					e.preventDefault();
					e.stopPropagation();

					const projectId = this.getAttribute('data-project-id');
					const projectTitle = this.getAttribute('data-project-title');
					const projectTasks = this.getAttribute('data-project-tasks');
					const projectOwner = this.getAttribute('data-project-owner');
					const projectOwnerEmail = this.getAttribute('data-project-owner-email');
					const csrfToken = this.getAttribute('data-csrf-token');

					// Vérification que toutes les données sont présentes
					if (!projectId || !csrfToken) {
						alert('Erreur : données manquantes pour la suppression');
						return;
					}

					// Configurer la modal
					projectTitleElement.textContent = `"${projectTitle}"`;
					projectNameElement.textContent = projectTitle;
					projectTasksElement.textContent = projectTasks;
					projectOwnerElement.textContent = projectOwner;
					projectOwnerEmailElement.textContent = projectOwnerEmail;

					// CORRECTION: Configuration correcte de l'action et du token
					deleteForm.action = `{{ path('admin_project_delete', {id: 'PLACEHOLDER_ID'}) }}`.replace('PLACEHOLDER_ID', projectId);
					tokenInput.value = csrfToken;

					// Afficher la modal
					deleteModal.show();
				});
			});

			// Double confirmation avant suppression
			deleteForm.addEventListener('submit', function (e) {
				const projectName = projectNameElement.textContent;
				if (!confirm(`Êtes-vous absolument sûr de vouloir supprimer le projet "${projectName}" ? Cette action est irréversible et supprimera également toutes les tâches associées.`)) {
					e.preventDefault();
				}
			});
		});
	</script>
{% endblock %}