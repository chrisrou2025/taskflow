{% extends 'base.html.twig' %}

{% block title %}Gestion des utilisateurs - Administration - TaskFlow
{% endblock %}

{% block body %}
	<div
		class="container-fluid">
		<!-- Header -->
		<div class="row mb-4">
			<div class="col-12">
				<div class="d-flex justify-content-between align-items-center">
					<div>
						<nav aria-label="breadcrumb">
							<ol class="breadcrumb">
								<li class="breadcrumb-item">
									<a href="{{ path('admin_dashboard') }}" class="text-decoration-none">Administration</a>
								</li>
								<li class="breadcrumb-item active">Utilisateurs</li>
							</ol>
						</nav>
						<h1 class="h3 mb-2">Gestion des utilisateurs</h1>
						<p class="text-muted mb-0">{{ total_users }}
							utilisateur(s) au total</p>
					</div>
					<div class="d-flex gap-2">
						<a href="{{ path('admin_dashboard') }}" class="btn btn-outline-secondary">
							<i class="fas fa-arrow-left me-2"></i>Retour
						</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Filtres et recherche -->
		<div class="row mb-4">
			<div class="col-12">
				<div class="card border-0 shadow-sm">
					<div class="card-body">
						<form method="get" class="row g-3 align-items-end">
							<div class="col-md-6">
								<label for="search" class="form-label">Rechercher</label>
								<div class="input-group">
									<span class="input-group-text">
										<i class="fas fa-search"></i>
									</span>
									<input type="text" class="form-control" id="search" name="search" value="{{ search }}" placeholder="Nom, prénom ou email...">
								</div>
							</div>
							<div class="col-md-3">
								<button type="submit" class="btn btn-primary">
									<i class="fas fa-search me-2"></i>Rechercher
								</button>
							</div>
							<div class="col-md-3">
								{% if search %}
									<a href="{{ path('admin_users') }}" class="btn btn-outline-secondary">
										<i class="fas fa-times me-2"></i>Effacer
									</a>
								{% endif %}
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

		<!-- Liste des utilisateurs -->
		<div class="row">
			<div class="col-12">
				<div class="card border-0 shadow-sm">
					<div class="card-header bg-white border-bottom">
						<h5 class="card-title mb-0">
							<i class="fas fa-users me-2 text-primary"></i>
							Utilisateurs
							{% if search %}
								(résultats pour "{{ search }}")
							{% endif %}
						</h5>
					</div>
					<div class="card-body p-0">
						{% if users is empty %}
							<div class="text-center py-5">
								{% if search %}
									<i class="fas fa-search fa-3x text-muted mb-3"></i>
									<h6 class="text-muted">Aucun utilisateur trouvé</h6>
									<p class="text-muted">Aucun utilisateur ne correspond à votre recherche "{{ search }}"</p>
								{% else %}
									<i class="fas fa-users fa-3x text-muted mb-3"></i>
									<h6 class="text-muted">Aucun utilisateur</h6>
								{% endif %}
							</div>
						{% else %}
							<div class="table-responsive">
								<table class="table table-hover mb-0">
									<thead class="table-light">
										<tr>
											<th>Utilisateur</th>
											<th>Email</th>
											<th>Rôle</th>
											<th>Activité</th>
											<th>Inscription</th>
											<th>Actions</th>
										</tr>
									</thead>
									<tbody>
										{% for user in users %}
											<tr>
												<td>
													<div>
														<strong>{{ user.fullName }}</strong>
														{% if user.id == app.user.id %}
															<span class="badge bg-info">Vous</span>
														{% endif %}
													</div>
												</td>
												<td>{{ user.email }}</td>
												<td>
													{% if 'ROLE_ADMIN' in user.roles %}
														<span class="badge bg-warning text-dark">Administrateur</span>
													{% else %}
														<span class="badge bg-secondary">Utilisateur</span>
													{% endif %}
												</td>
												<td>
													<div>
														<span class="badge bg-primary">{{ user.projects|length }}</span>
														projet(s)
														{% set totalTasks = 0 %}
														{% for project in user.projects %}
															{% set totalTasks = totalTasks + project.tasksCount %}
														{% endfor %}
														<br><small class="text-muted">{{ totalTasks }}
															tâche(s)</small>
													</div>
												</td>
												<td>
													<div>
														{{ user.createdAt|date('d/m/Y') }}
														<br><small class="text-muted">{{ user.createdAt|date('H:i') }}</small>
													</div>
												</td>
												<td>
													<div class="btn-group btn-group-sm">
														<a href="{{ path('admin_user_show', {id: user.id}) }}" class="btn btn-outline-primary" title="Voir le profil">
															<i class="fas fa-eye"></i>
														</a>
														{% if user.id != app.user.id %}
															<button type="button" class="btn btn-outline-warning" title="Changer le rôle" onclick="toggleUserRole({{ user.id }}, '{{ user.fullName }}')">
																<i class="fas fa-user-cog"></i>
															</button>
															<button type="button" class="btn btn-outline-danger" title="Supprimer l'utilisateur" data-bs-toggle="modal" data-bs-target="#deleteModal{{ user.id }}">
																<i class="fas fa-trash"></i>
															</button>
														{% endif %}
													</div>
												</td>
											</tr>>

											<!-- Modal de suppression -->
											{% if user.id != app.user.id %}
												<div class="modal fade" id="deleteModal{{ user.id }}" tabindex="-1">
													<div class="modal-dialog">
														<div class="modal-content">
															<div class="modal-header">
																<h5 class="modal-title">
																	<i class="fas fa-exclamation-triangle text-danger me-2"></i>
																	Confirmer la suppression
																</h5>
																<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
															</div>
															<div class="modal-body">
																<p>Êtes-vous sûr de vouloir supprimer l'utilisateur
																	<strong>"{{ user.fullName }}"</strong>
																	?</p>
																<div class="alert alert-danger">
																	<i class="fas fa-exclamation-triangle me-2"></i>
																	<strong>Attention :</strong>
																	Cette action supprimera définitivement :
																	<ul class="mb-0 mt-2">
																		<li>Le compte de
																			{{ user.fullName }}</li>
																		<li>Tous ses
																			{{ user.projects|length }}
																			projet(s)</li>
																		<li>Toutes les tâches associées</li>
																		<li>Tout l'historique</li>
																	</ul>
																</div>
															</div>
															<div class="modal-footer">
																<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
																	Annuler
																</button>
																<form method="post" action="{{ path('admin_user_delete', {id: user.id}) }}" class="d-inline">
																	<input type="hidden" name="_token" value="{{ csrf_token('delete-user' ~ user.id) }}">
																	<button type="submit" class="btn btn-danger">
																		<i class="fas fa-trash me-2"></i>Supprimer définitivement
																	</button>
																</form>
															</div>
														</div>
													</div>
												</div>
											{% endif %}
										{% endfor %}
									</tbody>
								</table>
							</div>

							<!-- Pagination -->
							{% if total_pages > 1 %}
								<div class="card-footer bg-white">
									<nav aria-label="Pagination des utilisateurs">
										<ul class="pagination justify-content-center mb-0">
											{% if current_page > 1 %}
												<li class="page-item">
													<a class="page-link" href="{{ path('admin_users', {page: current_page - 1, search: search}) }}">
														<i class="fas fa-chevron-left"></i>
														Précédent
													</a>
												</li>
											{% endif %}

											{% for page in 1..total_pages %}
												{% if page == current_page %}
													<li class="page-item active">
														<span class="page-link">{{ page }}</span>
													</li>
												{% elseif page == 1 or page == total_pages or (page >= current_page - 2 and page <= current_page + 2) %}
													<li class="page-item">
														<a class="page-link" href="{{ path('admin_users', {page: page, search: search}) }}">{{ page }}</a>
													</li>
												{% elseif page == current_page - 3 or page == current_page + 3 %}
													<li class="page-item disabled">
														<span class="page-link">...</span>
													</li>
												{% endif %}
											{% endfor %}

											{% if current_page < total_pages %}
												<li class="page-item">
													<a class="page-link" href="{{ path('admin_users', {page: current_page + 1, search: search}) }}">
														Suivant
														<i class="fas fa-chevron-right"></i>
													</a>
												</li>
											{% endif %}
										</ul>
									</nav>
									<div class="text-center mt-2">
										<small class="text-muted">
											Page
											{{ current_page }}
											sur
											{{ total_pages }}
											({{ total_users }}
											utilisateur(s) au total)
										</small>
									</div>
								</div>
							{% endif %}
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		function toggleUserRole(userId, userName) {
if (confirm (`Voulez-vous changer le rôle de ${userName} ?`)) {
fetch (`/admin/users/${userId}/toggle-role`, {
method: 'POST',
headers: {
'Content-Type': 'application/x-www-form-urlencoded',
'X-Requested-With': 'XMLHttpRequest'
},
body: `_token=${
document.querySelector('meta[name="csrf-token"]') ?. content || ''
}`
}).then(response => response.json()).then(data => {
if (data.success) {
alert(data.message);
window.location.reload();
} else {
alert('Erreur : ' + data.message);
}
}).catch(error => {
alert('Une erreur est survenue');
console.error('Error:', error);
});
}
}

document.addEventListener('DOMContentLoaded', function () { // Ajouter le token CSRF pour les requêtes AJAX
const token = document.querySelector('input[name="_token"]') ?. value;
if (token && !document.querySelector('meta[name="csrf-token"]')) {
const meta = document.createElement('meta');
meta.name = 'csrf-token';
meta.content = token;
document.head.appendChild(meta);
}
});
	</script>
{% endblock %}
