{% extends 'base.html.twig' %}

{% block title %}Gestion des utilisateurs - Administration - TaskFlow{% endblock %}

{% block body %}
	<div class="container-fluid">
		<div class="row mb-4">
			<div class="col-12">
				<div class="d-flex justify-content-between align-items-center">
					<div>
						<nav aria-label="breadcrumb">
							<ol class="breadcrumb">
								<li class="breadcrumb-item">
									<a href="{{ path('admin_dashboard') }}" class="text-decoration-none">Administration</a>
								</li>
								<li class="breadcrumb-item active">Utilisateurs</li>
							</ol>
						</nav>
						<h1 class="h3 mb-2">Gestion des utilisateurs</h1>
						<p class="text-muted mb-0">{{ total_users }} utilisateur(s) au total</p>
					</div>
					<div class="d-flex gap-2">
						<a href="{{ path('admin_dashboard') }}" class="btn btn-outline-secondary">
							<i class="fas fa-arrow-left me-2"></i>Retour
						</a>
					</div>
				</div>
			</div>
		</div>

		<div class="row mb-4">
			<div class="col-12">
				<div class="card border-0 shadow-sm">
					<div class="card-body">
						<form method="get" class="row g-3 align-items-end">
							<div class="col-md-6">
								<label for="search" class="form-label">Rechercher</label>
								<div class="input-group">
									<span class="input-group-text">
										<i class="fas fa-search"></i>
									</span>
									<input type="text" class="form-control" id="search" name="search" value="{{ search }}" placeholder="Nom, prénom ou email...">
								</div>
							</div>
							<div class="col-md-3">
								<button type="submit" class="btn btn-primary">
									<i class="fas fa-search me-2"></i>Rechercher
								</button>
							</div>
							<div class="col-md-3">
								{% if search %}
									<a href="{{ path('admin_users') }}" class="btn btn-outline-secondary">
										<i class="fas fa-times me-2"></i>Effacer
									</a>
								{% endif %}
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-12">
				<div class="card border-0 shadow-sm">
					<div class="card-header bg-white border-bottom">
						<h5 class="card-title mb-0">
							<i class="fas fa-users me-2 text-primary"></i>
							Utilisateurs
							{% if search %}
								(résultats pour "{{ search }}")
							{% endif %}
						</h5>
					</div>
					<div class="card-body p-0">
						{% if users is empty %}
							<div class="text-center py-5">
								{% if search %}
									<i class="fas fa-search fa-3x text-muted mb-3"></i>
									<h6 class="text-muted">Aucun utilisateur trouvé</h6>
									<p class="text-muted">Aucun utilisateur ne correspond à votre recherche "{{ search }}"</p>
								{% else %}
									<i class="fas fa-users fa-3x text-muted mb-3"></i>
									<h6 class="text-muted">Aucun utilisateur</h6>
								{% endif %}
							</div>
						{% else %}
							<div class="table-responsive">
								<table class="table table-hover mb-0">
									<thead class="table-light">
										<tr>
											<th>Utilisateur</th>
											<th>Email</th>
											<th>Rôle</th>
											<th>Activité</th>
											<th>Inscription</th>
											<th>Actions</th>
										</tr>
									</thead>
									<tbody>
										{% for user in users %}
											<tr>
												<td>
													<div>
														<strong>{{ user.fullName }}</strong>
														{% if user.id == app.user.id %}
															<span class="badge bg-info">Vous</span>
														{% endif %}
													</div>
												</td>
												<td>{{ user.email }}</td>
												<td>
													<span id="role-badge-{{ user.id }}">
														{% if 'ROLE_ADMIN' in user.roles %}
															<span class="badge bg-warning text-dark">Administrateur</span>
														{% else %}
															<span class="badge bg-secondary">Utilisateur</span>
														{% endif %}
													</span>
												</td>
												<td>
													<div>
														<span class="badge bg-primary">{{ user.projects|length }}</span>
														projet(s)
														{% set totalTasks = 0 %}
														{% for project in user.projects %}
															{% set totalTasks = totalTasks + project.tasksCount %}
														{% endfor %}
														<br><small class="text-muted">{{ totalTasks }} tâche(s)</small>
													</div>
												</td>
												<td>
													<div>
														{{ user.createdAt|date('d/m/Y') }}
														<br><small class="text-muted">{{ user.createdAt|date('H:i') }}</small>
													</div>
												</td>
												<td>
													<div class="btn-group btn-group-sm">
														<a href="{{ path('admin_user_show', {id: user.id}) }}" class="btn btn-outline-primary" title="Voir le profil">
															<i class="fas fa-eye"></i>
														</a>
														{% if user.id != app.user.id %}
															<button type="button"
																	class="btn btn-outline-warning"
																	title="Changer le rôle"
																	data-user-id="{{ user.id }}"
																	data-user-name="{{ user.fullName|e('html_attr') }}"
																	data-csrf-token="{{ csrf_token('toggle-role-' ~ user.id) }}"
																	onclick="toggleUserRole(this)">
																<i class="fas fa-user-cog"></i>
															</button>
															<button type="button"
																	class="btn btn-outline-danger"
																	title="Supprimer l'utilisateur"
																	data-bs-toggle="modal"
																	data-bs-target="#deleteUserModal"
																	data-user-id="{{ user.id }}"
																	data-user-name="{{ user.fullName|e('html_attr') }}"
																	data-projects-count="{{ user.projects|length }}"
																	data-csrf-token="{{ csrf_token('delete-user-' ~ user.id) }}"
																	onclick="showDeleteModal(this)">
																<i class="fas fa-trash"></i>
															</button>
														{% endif %}
													</div>
												</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>

							{% if total_pages > 1 %}
								<div class="card-footer bg-white">
									<nav aria-label="Pagination des utilisateurs">
										<ul class="pagination justify-content-center mb-0">
											{% if current_page > 1 %}
												<li class="page-item">
													<a class="page-link" href="{{ path('admin_users', {page: current_page - 1, search: search}) }}">
														<i class="fas fa-chevron-left"></i>
														Précédent
													</a>
												</li>
											{% endif %}

											{% for page in 1..total_pages %}
												{% if page == current_page %}
													<li class="page-item active">
														<span class="page-link">{{ page }}</span>
													</li>
												{% elseif page == 1 or page == total_pages or (page >= current_page - 2 and page <= current_page + 2) %}
													<li class="page-item">
														<a class="page-link" href="{{ path('admin_users', {page: page, search: search}) }}">{{ page }}</a>
													</li>
												{% elseif page == current_page - 3 or page == current_page + 3 %}
													<li class="page-item disabled">
														<span class="page-link">...</span>
													</li>
												{% endif %}
											{% endfor %}

											{% if current_page < total_pages %}
												<li class="page-item">
													<a class="page-link" href="{{ path('admin_users', {page: current_page + 1, search: search}) }}">
														Suivant
														<i class="fas fa-chevron-right"></i>
													</a>
												</li>
											{% endif %}
										</ul>
									</nav>
									<div class="text-center mt-2">
										<small class="text-muted">
											Page {{ current_page }} sur {{ total_pages }}
											({{ total_users }} utilisateur(s) au total)
										</small>
									</div>
								</div>
							{% endif %}
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="deleteUserModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						<i class="fas fa-exclamation-triangle text-danger me-2"></i>
						Confirmer la suppression
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<p>Êtes-vous sûr de vouloir supprimer l'utilisateur
						<strong id="modal-user-name"></strong>
						?</p>
					<div class="alert alert-danger">
						<i class="fas fa-exclamation-triangle me-2"></i>
						<strong>Attention :</strong>
						Cette action supprimera définitivement :
						<ul class="mb-0 mt-2">
							<li>Le compte de l'utilisateur</li>
							<li>Tous ses
								<span id="modal-projects-count"></span>
								projet(s)</li>
							<li>Toutes les tâches associées</li>
							<li>Tout l'historique</li>
						</ul>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
					<form method="post" action="" id="delete-user-form" class="d-inline">
						<input type="hidden" name="_token" value="" id="delete-user-csrf">
						<button type="submit" class="btn btn-danger">
							<i class="fas fa-trash me-2"></i>Supprimer définitivement
						</button>
					</form>
				</div>
			</div>
		</div>
	</div>
<script>
/**
 * Affiche le modal de suppression et remplit dynamiquement les données
 */
function showDeleteModal(button) {
    const userId = button.getAttribute('data-user-id');
    const userName = button.getAttribute('data-user-name');
    const projectsCount = button.getAttribute('data-projects-count');
    const csrfToken = button.getAttribute('data-csrf-token');
    
    // Remplir les données dans le modal
    document.getElementById('modal-user-name').innerText = `"${userName}"`;
    document.getElementById('modal-projects-count').innerText = projectsCount;

    // Définir l'action du formulaire et le token CSRF
    const form = document.getElementById('delete-user-form');
    form.action = `/admin/users/${userId}/delete`;
    document.getElementById('delete-user-csrf').value = csrfToken;
}

/**
 * Toggle le rôle d'un utilisateur via AJAX
 */
function toggleUserRole(buttonElement) {
    // Récupération des données depuis les attributs data
    const userId = buttonElement.dataset.userId;
    const userName = buttonElement.dataset.userName;
    const csrfToken = buttonElement.dataset.csrfToken;
    
    // Vérification des données requises
    if (!userId || !userName || !csrfToken) {
        alert('Erreur : données manquantes pour effectuer cette action.');
        console.error('Données manquantes:', { userId, userName, csrfToken });
        return;
    }
    
    // Confirmation de l'action
    if (!confirm(`Voulez-vous changer le rôle de ${userName} ?`)) {
        return;
    }
    
    // Désactivation temporaire du bouton pour éviter les clics multiples
    buttonElement.disabled = true;
    const originalContent = buttonElement.innerHTML;
    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    // Création du FormData pour envoyer le token CSRF
    const formData = new FormData();
    formData.append('_token', csrfToken);
    // Requête AJAX
    fetch(`/admin/users/${userId}/toggle-role`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Affichage du message de succès
            showAlert(data.message, 'success');
            
            // Mise à jour du badge de rôle dans le tableau
            updateRoleBadge(userId, data.new_role);
            
            // Optionnel: recharger la page après un délai
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showAlert('Erreur : ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erreur lors du changement de rôle:', error);
        showAlert('Une erreur inattendue est survenue. Veuillez réessayer.', 'error');
    })
    .finally(() => {
        // Réactivation du bouton
        buttonElement.disabled = false;
        buttonElement.innerHTML = originalContent;
    });
}

/**
 * Met à jour le badge de rôle dans le tableau
 */
function updateRoleBadge(userId, newRole) {
    const roleBadgeElement = document.getElementById(`role-badge-${userId}`);
    if (roleBadgeElement) {
        if (newRole === 'Administrateur') {
            roleBadgeElement.innerHTML = '<span class="badge bg-warning text-dark">Administrateur</span>';
        } else {
            roleBadgeElement.innerHTML = '<span class="badge bg-secondary">Utilisateur</span>';
        }
    }
}

/**
 * Affiche une alerte temporaire
 */
function showAlert(message, type = 'info') {
    // Création de l'alerte Bootstrap
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
            <i class="fas ${iconClass} me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    // Ajout de l'alerte au DOM
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    // Suppression automatique après 5 secondes
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert.position-fixed');
        alerts.forEach(alert => {
            if (alert.textContent.includes(message)) {
                alert.remove();
            }
        });
    }, 5000);
}
</script>
{% endblock %}