{% extends 'base.html.twig' %}

{% block title %}Mes demandes de collaboration{% endblock %}

{% block body %}
<div class="container-fluid px-2 px-md-3">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center">
                <div>
                    <h1 class="h3 h2-md mb-2">
                        <i class="fas fa-handshake me-2 text-primary"></i>
                        Demandes de collaboration
                    </h1>
                    <p class="text-muted mb-0">
                        Gérez vos invitations reçues et envoyées
                    </p>
                </div>
                <div class="d-flex gap-2 mt-3 mt-sm-0">
                    <span class="badge bg-primary">
                        {{ received_requests|length }} reçue{{ received_requests|length > 1 ? 's' : '' }}
                    </span>
                    <span class="badge bg-info">
                        {{ sent_requests|length }} envoyée{{ sent_requests|length > 1 ? 's' : '' }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 p-0">
            <ul class="nav nav-tabs nav-fill border-0" id="collaborationTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active position-relative py-3 px-4 border-0" 
                            id="received-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#received" 
                            type="button" 
                            role="tab" 
                            aria-controls="received" 
                            aria-selected="true">
                        <i class="fas fa-inbox me-2"></i>
                        <span class="d-none d-sm-inline">Demandes </span>reçues
                        {% if received_requests|length > 0 %}
                            <span class="badge bg-primary rounded-pill ms-2">{{ received_requests|length }}</span>
                        {% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link position-relative py-3 px-4 border-0" 
                            id="sent-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#sent" 
                            type="button" 
                            role="tab" 
                            aria-controls="sent" 
                            aria-selected="false">
                        <i class="fas fa-paper-plane me-2"></i>
                        <span class="d-none d-sm-inline">Demandes </span>envoyées
                        {% if sent_requests|length > 0 %}
                            <span class="badge bg-info rounded-pill ms-2">{{ sent_requests|length }}</span>
                        {% endif %}
                    </button>
                </li>
            </ul>
        </div>

        <div class="card-body p-0">
            <div class="tab-content" id="collaborationTabContent">
                <div class="tab-pane fade show active" id="received" role="tabpanel" aria-labelledby="received-tab">
                    <div class="p-3 p-md-4">
                        {% if received_requests is empty %}
                            <div class="text-center py-5">
                                <div class="mb-3">
                                    <i class="fas fa-inbox fa-4x text-muted"></i>
                                </div>
                                <h5 class="mb-3">Aucune invitation reçue</h5>
                                <p class="text-muted mb-4 px-3">
                                    Vous n'avez reçu aucune demande de collaboration pour le moment.
                                </p>
                                <a href="{{ path('project_index') }}" class="btn btn-outline-primary">
                                    <i class="fas fa-folder me-2"></i>Voir mes projets
                                </a>
                            </div>
                        {% else %}
                            {% if received_requests|filter(r => not r.isPending)|length > 0 %}
                                <div class="card border-0 bg-warning bg-opacity-10 mb-3">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">
                                                    <i class="fas fa-broom me-2 text-warning"></i>
                                                    Actions de nettoyage
                                                </h6>
                                                <small class="text-muted">{{ received_requests|filter(r => not r.isPending)|length }} demande(s) traitée(s) peuvent être supprimées</small>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-warning" id="clearProcessedReceived" data-count="{{ received_requests|filter(r => not r.isPending)|length }}">
                                                <i class="fas fa-broom me-1"></i>Nettoyer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            
                            <div class="card border-0 bg-light mb-3">
                                <div class="card-body p-3">
                                    <div class="d-flex flex-wrap gap-2 align-items-center">
                                        <span class="text-muted small me-2">Filtrer :</span>
                                        <button class="collaboration-filter-btn btn btn-sm btn-outline-secondary active" data-filter="all">
                                            Toutes ({{ received_requests|length }})
                                        </button>
                                        <button class="collaboration-filter-btn btn btn-sm btn-outline-warning" data-filter="pending">
                                            En attente ({{ received_requests|filter(r => r.isPending)|length }})
                                        </button>
                                        <button class="collaboration-filter-btn btn btn-sm btn-outline-success" data-filter="accepted">
                                            Acceptées ({{ received_requests|filter(r => r.isAccepted)|length }})
                                        </button>
                                        <button class="collaboration-filter-btn btn btn-sm btn-outline-danger" data-filter="refused">
                                            Refusées ({{ received_requests|filter(r => r.isRefused)|length }})
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-none d-lg-block collaboration-table" id="received-requests">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Projet</th>
                                                        <th>Expéditeur</th>
                                                        <th>Date</th>
                                                        <th>Statut</th>
                                                        <th class="text-end">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for request in received_requests %}
                                                        <tr class="request-item {{ request.isPending ? 'table-warning' : (request.isAccepted ? 'table-success' : (request.isRefused ? 'table-danger' : '')) }}" 
                                                            data-status="{{ request.status }}" data-request-id="{{ request.id }}">
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <div class="bg-primary bg-opacity-10 rounded d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                                        <i class="fas fa-folder text-primary"></i>
                                                                    </div>
                                                                    <div>
                                                                        <h6 class="mb-1 fw-bold">
                                                                            <a href="{{ path('project_show', {id: request.project.id}) }}" class="text-decoration-none">
                                                                                {{ request.project.title }}
                                                                            </a>
                                                                        </h6>
                                                                        {% if request.message %}
                                                                            <small class="text-muted">{{ request.message|length > 50 ? request.message|slice(0, 50) ~ '...' : request.message }}</small>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <div class="bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                                                        <small class="text-success fw-bold">
                                                                            {{ request.sender.firstName|first }}{{ request.sender.lastName|first }}
                                                                        </small>
                                                                    </div>
                                                                    <span>{{ request.sender.fullName }}</span>
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <span class="text-muted small">{{ request.timeAgo }}</span>
                                                            </td>
                                                            <td>
                                                                {% set status_class = request.isPending ? 'warning' : (request.isAccepted ? 'success' : 'danger') %}
                                                                {% set status_text = request.isPending ? 'En attente' : (request.isAccepted ? 'Acceptée' : 'Refusée') %}
                                                                <span class="badge bg-{{ status_class }}{{ status_class == 'warning' ? ' text-dark' : '' }}">
                                                                    <i class="{{ request.statusIcon }} me-1"></i>{{ status_text }}
                                                                </span>
                                                            </td>
                                                            <td class="text-end">
                                                                <div class="d-flex justify-content-end align-items-center gap-1">
                                                                    {% if request.isPending %}
                                                                        <form method="post" action="{{ path('collaboration_request_refuse', {id: request.id}) }}" class="d-inline">
                                                                            <input type="hidden" name="_token" value="{{ csrf_token('refuse-request-' ~ request.id) }}">
                                                                            <button class="btn btn-sm btn-outline-danger" 
                                                                                    onclick="return confirm('Êtes-vous sûr de vouloir refuser cette invitation ?')"
                                                                                    title="Refuser l'invitation">
                                                                                <i class="fas fa-times"></i>
                                                                                <span class="d-none d-xl-inline ms-1">Refuser</span>
                                                                            </button>
                                                                        </form>
                                                                        <form method="post" action="{{ path('collaboration_request_accept', {id: request.id}) }}" class="d-inline">
                                                                            <input type="hidden" name="_token" value="{{ csrf_token('accept-request-' ~ request.id) }}">
                                                                            <button class="btn btn-sm btn-success" title="Accepter l'invitation">
                                                                                <i class="fas fa-check"></i>
                                                                                <span class="d-none d-xl-inline ms-1">Accepter</span>
                                                                            </button>
                                                                        </form>
                                                                    {% endif %}
                                                                    {% if not request.isPending %}
                                                                    <button type="button" 
                                                                            class="btn btn-sm btn-outline-danger delete-request-btn" 
                                                                            data-bs-toggle="modal" 
                                                                            data-bs-target="#deleteRequestModal"
                                                                            data-request-id="{{ request.id }}" 
                                                                            data-request-title="{{ request.project.title }}"
                                                                            title="Supprimer">
                                                                        <i class="fas fa-trash"></i>
                                                                        <span class="d-none d-xl-inline ms-1">Supprimer</span>
                                                                    </button>
                                                                    {% endif %}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-lg-none" id="received-requests-mobile">
                                {% for request in received_requests %}
                                    <div class="card mb-3 shadow-sm border-0 request-item {{ request.isPending ? 'border-warning' : (request.isAccepted ? 'border-success' : (request.isRefused ? 'border-danger' : '')) }}" 
                                         data-status="{{ request.status }}" data-request-id="{{ request.id }}">
                                        <div class="card-body">
                                            <div class="d-flex align-items-start mb-3">
                                                <div class="bg-primary bg-opacity-10 rounded d-flex align-items-center justify-content-center me-3 flex-shrink-0" style="width: 48px; height: 48px;">
                                                    <i class="fas fa-folder text-primary fa-lg"></i>
                                                </div>
                                                <div class="flex-grow-1 min-width-0">
                                                    <h6 class="fw-bold mb-1">
                                                        <a href="{{ path('project_show', {id: request.project.id}) }}" class="text-decoration-none">
                                                            {{ request.project.title }}
                                                        </a>
                                                    </h6>
                                                    {% if request.message %}
                                                        <p class="text-muted small mb-2 fst-italic">"{{ request.message|length > 80 ? request.message|slice(0, 80) ~ '...' : request.message }}"</p>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <ul class="list-unstyled mb-0 small text-muted">
                                                <li class="mb-1">
                                                    <strong class="text-dark">De :</strong>
                                                    <div class="d-inline-flex align-items-center">
                                                        <div class="bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-1" style="width: 20px; height: 20px;">
                                                            <small class="text-success fw-bold" style="font-size: 0.7rem;">
                                                                {{ request.sender.firstName|first }}{{ request.sender.lastName|first }}
                                                            </small>
                                                        </div>
                                                        {{ request.sender.fullName }}
                                                    </div>
                                                </li>
                                                <li class="mb-1">
                                                    <strong class="text-dark">Date :</strong>
                                                    {{ request.timeAgo }}
                                                </li>
                                                <li>
                                                    <strong class="text-dark">Statut :</strong>
                                                    {% set status_class = request.isPending ? 'warning' : (request.isAccepted ? 'success' : 'danger') %}
                                                    {% set status_text = request.isPending ? 'En attente' : (request.isAccepted ? 'Acceptée' : 'Refusée') %}
                                                    <span class="badge bg-{{ status_class }}{{ status_class == 'warning' ? ' text-dark' : '' }}">{{ status_text }}</span>
                                                </li>
                                            </ul>
                                            
                                            <div class="d-flex justify-content-end align-items-center gap-2 mt-3">
                                                {% if request.isPending %}
                                                    <form method="post" action="{{ path('collaboration_request_refuse', {id: request.id}) }}" class="d-inline">
                                                        <input type="hidden" name="_token" value="{{ csrf_token('refuse-request-' ~ request.id) }}">
                                                        <button class="btn btn-sm btn-outline-danger" 
                                                                onclick="return confirm('Êtes-vous sûr de vouloir refuser cette invitation ?')"
                                                                title="Refuser l'invitation">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </form>
                                                    <form method="post" action="{{ path('collaboration_request_accept', {id: request.id}) }}" class="d-inline">
                                                        <input type="hidden" name="_token" value="{{ csrf_token('accept-request-' ~ request.id) }}">
                                                        <button class="btn btn-sm btn-success" title="Accepter l'invitation">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                    </form>
                                                {% endif %}
                                                {% if not request.isPending %}
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-danger delete-request-btn" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#deleteRequestModal"
                                                        data-request-id="{{ request.id }}" 
                                                        data-request-title="{{ request.project.title }}"
                                                        title="Supprimer">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="tab-pane fade" id="sent" role="tabpanel" aria-labelledby="sent-tab">
                    <div class="p-3 p-md-4">
                        {% if sent_requests is empty %}
                            <div class="text-center py-5">
                                <div class="mb-3">
                                    <i class="fas fa-paper-plane fa-4x text-muted"></i>
                                </div>
                                <h5 class="mb-3">Aucune invitation envoyée</h5>
                                <p class="text-muted mb-4 px-3">
                                    Vous n'avez encore envoyé aucune demande de collaboration.
                                </p>
                                <a href="{{ path('project_index') }}" class="btn btn-outline-info">
                                    <i class="fas fa-user-plus me-2"></i>Inviter des collaborateurs
                                </a>
                            </div>
                        {% else %}
                             {% if sent_requests|filter(r => not r.isPending)|length > 0 %}
                                <div class="card border-0 bg-warning bg-opacity-10 mb-3">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">
                                                    <i class="fas fa-broom me-2 text-warning"></i>
                                                    Actions de nettoyage
                                                </h6>
                                                <small class="text-muted">{{ sent_requests|filter(r => not r.isPending)|length }} demande(s) traitée(s) peuvent être supprimées</small>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-warning" id="clearProcessedSent" data-count="{{ sent_requests|filter(r => not r.isPending)|length }}">
                                                <i class="fas fa-broom me-1"></i>Nettoyer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            
                            <div class="card border-0 bg-light mb-3">
                                <div class="card-body p-3">
                                    <div class="d-flex flex-wrap gap-2 align-items-center">
                                        <span class="text-muted small me-2">Filtrer :</span>
                                        <button class="collaboration-filter-btn btn btn-sm btn-outline-secondary active filter-btn-sent" data-filter="all">
                                            Toutes ({{ sent_requests|length }})
                                        </button>
                                        <button class="collaboration-filter-btn btn btn-sm btn-outline-warning filter-btn-sent" data-filter="pending">
                                            En attente ({{ sent_requests|filter(r => r.isPending)|length }})
                                        </button>
                                        <button class="collaboration-filter-btn btn btn-sm btn-outline-success filter-btn-sent" data-filter="accepted">
                                            Acceptées ({{ sent_requests|filter(r => r.isAccepted)|length }})
                                        </button>
                                        <button class="collaboration-filter-btn btn btn-sm btn-outline-danger filter-btn-sent" data-filter="refused">
                                            Refusées ({{ sent_requests|filter(r => r.isRefused)|length }})
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-none d-lg-block collaboration-table" id="sent-requests">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle mb-0">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Projet</th>
                                                        <th>Destinataire</th>
                                                        <th>Date</th>
                                                        <th>Statut</th>
                                                        <th class="text-end">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for request in sent_requests %}
                                                        <tr class="request-item-sent {{ request.isPending ? 'table-warning' : (request.isAccepted ? 'table-success' : (request.isRefused ? 'table-danger' : '')) }}" 
                                                            data-status="{{ request.status }}" data-request-id="{{ request.id }}">
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <div class="bg-primary bg-opacity-10 rounded d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                                        <i class="fas fa-folder text-primary"></i>
                                                                    </div>
                                                                    <div>
                                                                        <h6 class="mb-1 fw-bold">
                                                                            <a href="{{ path('project_show', {id: request.project.id}) }}" class="text-decoration-none">
                                                                                {{ request.project.title }}
                                                                            </a>
                                                                        </h6>
                                                                        {% if request.message %}
                                                                            <small class="text-muted">{{ request.message|length > 50 ? request.message|slice(0, 50) ~ '...' : request.message }}</small>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <div class="bg-info bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                                                        <small class="text-info fw-bold">
                                                                            {{ request.invitedUser.firstName|first }}{{ request.invitedUser.lastName|first }}
                                                                        </small>
                                                                    </div>
                                                                    <span>{{ request.invitedUser.fullName }}</span>
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <span class="text-muted small">{{ request.timeAgo }}</span>
                                                            </td>
                                                            <td>
                                                                {% set status_class = request.isPending ? 'warning' : (request.isAccepted ? 'success' : 'danger') %}
                                                                {% set status_text = request.isPending ? 'En attente' : (request.isAccepted ? 'Acceptée' : 'Refusée') %}
                                                                <span class="badge bg-{{ status_class }}{{ status_class == 'warning' ? ' text-dark' : '' }}">
                                                                    <i class="{{ request.statusIcon }} me-1"></i>{{ status_text }}
                                                                </span>
                                                            </td>
                                                            <td class="text-end">
                                                                <div class="d-flex justify-content-end align-items-center gap-1">
                                                                    <button type="button" 
                                                                            class="btn btn-sm btn-outline-danger delete-request-btn" 
                                                                            data-bs-toggle="modal" 
                                                                            data-bs-target="#deleteRequestModal"
                                                                            data-request-id="{{ request.id }}" 
                                                                            data-request-title="{{ request.project.title }}"
                                                                            title="Supprimer">
                                                                        <i class="fas fa-trash"></i>
                                                                        <span class="d-none d-xl-inline ms-1">Supprimer</span>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-lg-none" id="sent-requests-mobile">
                                {% for request in sent_requests %}
                                    <div class="card mb-3 shadow-sm border-0 request-item-sent {{ request.isPending ? 'border-warning' : (request.isAccepted ? 'border-success' : (request.isRefused ? 'border-danger' : '')) }}" 
                                         data-status="{{ request.status }}" data-request-id="{{ request.id }}">
                                        <div class="card-body">
                                            <div class="d-flex align-items-start mb-3">
                                                <div class="bg-primary bg-opacity-10 rounded d-flex align-items-center justify-content-center me-3 flex-shrink-0" style="width: 48px; height: 48px;">
                                                    <i class="fas fa-folder text-primary fa-lg"></i>
                                                </div>
                                                <div class="flex-grow-1 min-width-0">
                                                    <h6 class="fw-bold mb-1">
                                                        <a href="{{ path('project_show', {id: request.project.id}) }}" class="text-decoration-none">
                                                            {{ request.project.title }}
                                                        </a>
                                                    </h6>
                                                    {% if request.message %}
                                                        <p class="text-muted small mb-2 fst-italic">"{{ request.message|length > 80 ? request.message|slice(0, 80) ~ '...' : request.message }}"</p>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <ul class="list-unstyled mb-0 small text-muted">
                                                <li class="mb-1">
                                                    <strong class="text-dark">À :</strong>
                                                    <div class="d-inline-flex align-items-center">
                                                        <div class="bg-info bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-1" style="width: 20px; height: 20px;">
                                                            <small class="text-info fw-bold" style="font-size: 0.7rem;">
                                                                {{ request.invitedUser.firstName|first }}{{ request.invitedUser.lastName|first }}
                                                            </small>
                                                        </div>
                                                        {{ request.invitedUser.fullName }}
                                                    </div>
                                                </li>
                                                <li class="mb-1">
                                                    <strong class="text-dark">Date :</strong>
                                                    {{ request.timeAgo }}
                                                </li>
                                                <li>
                                                    <strong class="text-dark">Statut :</strong>
                                                    {% set status_class = request.isPending ? 'warning' : (request.isAccepted ? 'success' : 'danger') %}
                                                    {% set status_text = request.isPending ? 'En attente' : (request.isAccepted ? 'Acceptée' : 'Refusée') %}
                                                    <span class="badge bg-{{ status_class }}{{ status_class == 'warning' ? ' text-dark' : '' }}">{{ status_text }}</span>
                                                </li>
                                            </ul>
                                            
                                            <div class="d-flex justify-content-end align-items-center gap-2 mt-3">
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-danger delete-request-btn" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#deleteRequestModal"
                                                        data-request-id="{{ request.id }}" 
                                                        data-request-title="{{ request.project.title }}"
                                                        title="Supprimer">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bulkActionModal" tabindex="-1" aria-labelledby="bulkActionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="bulkActionModalLabel">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                    Confirmer l'action
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <p id="bulkActionMessage" class="mb-3"></p>
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Information :</strong>
                    Cette action ne peut pas être annulée.
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary flex-grow-1" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn flex-grow-1" id="confirmBulkAction">Confirmer</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteRequestModal" tabindex="-1" aria-labelledby="deleteRequestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title text-danger" id="deleteRequestModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmer la suppression
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Êtes-vous sûr de vouloir supprimer définitivement cette demande ?</p>
                <div class="bg-light rounded p-3 mb-3">
                    <strong id="requestTitle"></strong>
                </div>
                <div class="alert alert-warning mb-0">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-exclamation-triangle me-2 mt-1 flex-shrink-0"></i>
                        <div>
                            <strong>Attention :</strong>
                            Cette action supprimera définitivement la demande de collaboration. Cette action est irréversible.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary flex-grow-1" data-bs-dismiss="modal">Annuler</button>
                <form method="post" action="#" id="deleteRequestForm" class="flex-grow-1">
                    <input type="hidden" name="_token" id="deleteRequestToken" value="">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-trash me-2"></i>Supprimer définitivement
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Système de filtres harmonisé pour les demandes reçues
        const filterButtons = document.querySelectorAll('.collaboration-filter-btn:not(.filter-btn-sent)');
        const requestItems = document.querySelectorAll('.request-item');
        
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                const filter = this.dataset.filter;
                
                filterButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                requestItems.forEach(item => {
                    const status = item.dataset.status;
                    
                    let show = (filter === 'all') ? true : (status === filter);
                    
                    // Utiliser la bonne valeur de display selon le contexte
                    if (item.tagName === 'TR') {
                        // Pour les lignes de tableau
                        item.style.display = show ? 'table-row' : 'none';
                    } else {
                        // Pour les cartes mobiles
                        item.style.display = show ? 'block' : 'none';
                    }
                });
            });
        });

        // Système de filtres harmonisé pour les demandes envoyées
        const filterButtonsSent = document.querySelectorAll('.filter-btn-sent');
        const requestItemsSent = document.querySelectorAll('.request-item-sent');
        
        filterButtonsSent.forEach(button => {
            button.addEventListener('click', function() {
                const filter = this.dataset.filter;
                
                filterButtonsSent.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                requestItemsSent.forEach(item => {
                    const status = item.dataset.status;
                    
                    let show = (filter === 'all') ? true : (status === filter);
                    
                    // Utiliser la bonne valeur de display selon le contexte
                    if (item.tagName === 'TR') {
                        // Pour les lignes de tableau
                        item.style.display = show ? 'table-row' : 'none';
                    } else {
                        // Pour les cartes mobiles
                        item.style.display = show ? 'block' : 'none';
                    }
                });
            });
        });

        // Gestion des modales et actions harmonisées
        const modal = new bootstrap.Modal(document.getElementById('bulkActionModal'));
        const modalMessage = document.getElementById('bulkActionMessage');
        const confirmButton = document.getElementById('confirmBulkAction');
        
        const deleteRequestModal = new bootstrap.Modal(document.getElementById('deleteRequestModal'));
        const requestTitleElement = document.getElementById('requestTitle');
        const deleteRequestForm = document.getElementById('deleteRequestForm');
        const deleteRequestTokenInput = document.getElementById('deleteRequestToken');

        // Tokens CSRF pour la suppression
        const csrfTokens = {
            {% for request in received_requests %}
                '{{ request.id }}': '{{ csrf_token('delete-request-' ~ request.id) }}'{{ not loop.last ? ',' : '' }}
            {% endfor %}
            {% if received_requests|length > 0 and sent_requests|length > 0 %},{% endif %}
            {% for request in sent_requests %}
                '{{ request.id }}': '{{ csrf_token('delete-request-' ~ request.id) }}'{{ not loop.last ? ',' : '' }}
            {% endfor %}
        };
        // Gestion des boutons de suppression individuelle
        document.addEventListener('click', function(e) {
            if (e.target.closest('.delete-request-btn')) {
                const button = e.target.closest('.delete-request-btn');
                const requestId = button.getAttribute('data-request-id');
                const requestTitle = button.getAttribute('data-request-title');
            
                if (requestTitleElement) {
                    requestTitleElement.textContent = `Demande pour le projet : ${requestTitle}`;
                }
                
                if (deleteRequestForm) {
                    const deletePath = "{{ path('collaboration_request_delete', {id: '__REQUEST_ID__'}) }}";
                    deleteRequestForm.action = deletePath.replace('__REQUEST_ID__', requestId);
                }
                
                if (deleteRequestTokenInput) {
                    const token = csrfTokens[requestId];
                    if (token) {
                        deleteRequestTokenInput.value = token;
                    } else {
                        console.error('Token CSRF introuvable pour la demande ID:', requestId);
                    }
                }
            }
        });
        // Actions en lot harmonisées
        document.getElementById('clearProcessedReceived')?.addEventListener('click', function() {
            const count = this.dataset.count;
            if (count == 0) {
                showToast('Aucune demande traitée à nettoyer', 'warning');
                return;
            }
            showBulkModal(`Êtes-vous sûr de vouloir supprimer toutes les demandes traitées (${count}) ?`, 'btn-warning', () => {
                bulkAction('clear-processed-received');
            });
        });
        document.getElementById('clearProcessedSent')?.addEventListener('click', function() {
            const count = this.dataset.count;
            if (count == 0) {
                showToast('Aucune demande traitée à nettoyer', 'warning');
                return;
            }
            showBulkModal(`Êtes-vous sûr de vouloir supprimer toutes vos demandes traitées (${count}) ?`, 'btn-warning', () => {
                bulkAction('clear-processed-sent');
            });
        });
        function showBulkModal(message, buttonClass, callback) {
            modalMessage.textContent = message;
            confirmButton.className = `btn flex-grow-1 ${buttonClass}`;
            confirmButton.onclick = () => {
                callback();
                modal.hide();
            };
            modal.show();
        }
        
        function bulkAction(action) {
            const routeMapping = {
                'clear-processed-received': '{{ path('collaboration_bulk_clear_processed_received') }}',
                'clear-processed-sent': '{{ path('collaboration_bulk_clear_processed_sent') }}'
            };
            const url = routeMapping[action];
            if (!url) {
                showToast('Action inconnue', 'error');
                return;
            }
            
            showLoadingOverlay();
            const formData = new FormData();
            formData.append('_token', generateCsrfToken(action));
            
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoadingOverlay();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showToast(data.message || 'Une erreur est survenue', 'error');
                }
            })
            .catch(error => {
                hideLoadingOverlay();
                console.error('Erreur AJAX:', error);
                showToast('Erreur de communication avec le serveur', 'error');
            });
        }
        
        function generateCsrfToken(action) {
            const tokenMapping = {
                'clear-processed-received': '{{ csrf_token('bulk-clear-processed-received') }}',
                'clear-processed-sent': '{{ csrf_token('bulk-clear-processed-sent') }}'
            };
            return tokenMapping[action] || '';
        }
        
        function showLoadingOverlay() {
            const overlay = document.createElement('div');
            overlay.id = 'loading-overlay';
            overlay.innerHTML = `
                <div class="d-flex justify-content-center align-items-center position-fixed top-0 start-0 w-100 h-100" style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
                    <div class="spinner-border text-light" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.remove();
            }
        }
        
        function showToast(message, type) {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }
        
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '1080';
            document.body.appendChild(container);
            return container;
        }
    });
    </script>
{% endblock %}