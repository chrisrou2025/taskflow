{% extends 'base.html.twig' %}

{% block title %}Demande de collaboration{% endblock %}

{% block body %}
<div class="container-fluid px-2 px-md-4 fade-in">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            <!-- En-tête avec statut -->
            <div class="card border-0 shadow-sm mb-4 {{ request.isPending ? 'border-start border-warning border-3' : '' }}">
                <div class="card-body p-3 p-md-4">
                    <div class="row align-items-center">
                        <div class="col-12 col-md-8">
                            <div class="d-flex align-items-center">
                                <div class="bg-{{ request.statusBadgeClass|replace({'bg-': ''}) }} bg-opacity-10 rounded-circle me-3 d-flex align-items-center justify-content-center" 
                                     style="width: 64px; height: 64px;">
                                    <i class="{{ request.statusIcon }} text-{{ request.statusBadgeClass|replace({'bg-': ''}) }} fa-2x"></i>
                                </div>
                                <div>
                                    <h1 class="h4 h3-md mb-2">Demande de collaboration</h1>
                                    <p class="text-muted mb-0">
                                        {% if perspective == 'recipient' %}
                                            Vous avez reçu une invitation de {{ request.sender.fullName }}
                                        {% else %}
                                            Vous avez invité {{ request.invitedUser.fullName }}
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4 mt-3 mt-md-0">
                            <div class="text-center text-md-end">
                                <span class="badge {{ request.statusBadgeClass }} fs-6 px-3 py-2">
                                    <i class="{{ request.statusIcon }} me-2"></i>
                                    {{ request.statusLabel }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <!-- Informations principales -->
                <div class="col-12 col-lg-8">
                    <!-- Informations sur le projet -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white border-0 pb-0">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-folder me-2 text-primary"></i>
                                Projet concerné
                            </h5>
                        </div>
                        <div class="card-body p-3 p-md-4">
                            <div class="d-flex align-items-start">
                                <div class="bg-primary bg-opacity-10 rounded-circle me-3 d-flex align-items-center justify-content-center" 
                                     style="width: 48px; height: 48px;">
                                    <i class="fas fa-folder fa-lg text-primary"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-2">
                                        <a href="{{ path('project_show', {id: request.project.id}) }}" 
                                           class="text-decoration-none fw-bold">
                                            {{ request.project.title }}
                                        </a>
                                    </h6>
                                    {% if request.project.description %}
                                        <p class="text-muted mb-0 small">{{ request.project.description }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Message d'invitation -->
                    {% if request.message %}
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white border-0 pb-0">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-comment me-2 text-info"></i>
                                    Message d'invitation
                                </h5>
                            </div>
                            <div class="card-body p-3 p-md-4">
                                <div class="bg-light rounded p-3">
                                    <p class="mb-0 fst-italic">{{ request.message|nl2br }}</p>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Réponse (si elle existe) -->
                    {% if request.response %}
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white border-0 pb-0">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-reply me-2 text-secondary"></i>
                                    Réponse
                                </h5>
                            </div>
                            <div class="card-body p-3 p-md-4">
                                <div class="alert alert-{{ request.isAccepted ? 'success' : 'danger' }} mb-0">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-{{ request.isAccepted ? 'check-circle' : 'times-circle' }} me-2 mt-1"></i>
                                        <div>{{ request.response|nl2br }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Sidebar avec informations complémentaires -->
                <div class="col-12 col-lg-4">
                    <!-- Personnes impliquées -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white border-0 pb-0">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-users me-2 text-info"></i>
                                Personnes impliquées
                            </h5>
                        </div>
                        <div class="card-body p-3 p-md-4">
                            <!-- Expéditeur -->
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-primary bg-opacity-10 rounded-circle me-3 d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px;">
                                    <small class="text-primary fw-bold">{{ request.sender.firstName|first }}{{ request.sender.lastName|first }}</small>
                                </div>
                                <div>
                                    <div class="fw-medium">{{ request.sender.fullName }}</div>
                                    <small class="text-muted">Expéditeur</small>
                                </div>
                            </div>

                            <div class="text-center mb-3">
                                <i class="fas fa-arrow-down text-muted"></i>
                            </div>

                            <!-- Destinataire -->
                            <div class="d-flex align-items-center">
                                <div class="bg-success bg-opacity-10 rounded-circle me-3 d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px;">
                                    <small class="text-success fw-bold">{{ request.invitedUser.firstName|first }}{{ request.invitedUser.lastName|first }}</small>
                                </div>
                                <div>
                                    <div class="fw-medium">{{ request.invitedUser.fullName }}</div>
                                    <small class="text-muted">Destinataire</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chronologie -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white border-0 pb-0">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-clock me-2 text-warning"></i>
                                Chronologie
                            </h5>
                        </div>
                        <div class="card-body p-3 p-md-4">
                            <div class="timeline">
                                <!-- Envoi de l'invitation -->
                                <div class="timeline-item d-flex mb-3">
                                    <div class="timeline-marker bg-primary me-3 mt-1" style="width: 12px; height: 12px; border-radius: 50%;"></div>
                                    <div class="flex-grow-1">
                                        <div class="fw-medium small">Invitation envoyée</div>
                                        <div class="text-muted small">{{ request.createdAt|date('d/m/Y à H:i') }}</div>
                                        <div class="text-muted small">{{ request.timeAgo }}</div>
                                    </div>
                                </div>

                                <!-- Réponse (si elle existe) -->
                                {% if request.respondedAt %}
                                    <div class="timeline-item d-flex">
                                        <div class="timeline-marker bg-{{ request.isAccepted ? 'success' : 'danger' }} me-3 mt-1" style="width: 12px; height: 12px; border-radius: 50%;"></div>
                                        <div class="flex-grow-1">
                                            <div class="fw-medium small">Invitation {{ request.isAccepted ? 'acceptée' : 'refusée' }}</div>
                                            <div class="text-muted small">{{ request.respondedAt|date('d/m/Y à H:i') }}</div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="timeline-item d-flex">
                                        <div class="timeline-marker bg-secondary bg-opacity-25 me-3 mt-1" style="width: 12px; height: 12px; border-radius: 50%; border: 2px solid #6c757d;"></div>
                                        <div class="flex-grow-1">
                                            <div class="fw-medium small text-muted">En attente de réponse</div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Actions rapides -->
                    {% if perspective == 'recipient' and request.isPending %}
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white border-0 pb-0">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-hand-pointer me-2 text-success"></i>
                                    Actions rapides
                                </h5>
                            </div>
                            <div class="card-body p-3 p-md-4">
                                <div class="d-grid gap-2">
                                    <form method="post" action="{{ path('collaboration_request_accept', {id: request.id}) }}">
                                        <input type="hidden" name="_token" value="{{ csrf_token('accept-request-' ~ request.id) }}">
                                        <button class="btn btn-success w-100">
                                            <i class="fas fa-check me-2"></i>Accepter l'invitation
                                        </button>
                                    </form>
                                    <form method="post" action="{{ path('collaboration_request_refuse', {id: request.id}) }}">
                                        <input type="hidden" name="_token" value="{{ csrf_token('refuse-request-' ~ request.id) }}">
                                        <input type="hidden" name="response" value="Demande refusée.">
                                        <button class="btn btn-outline-danger w-100" 
                                                onclick="return confirm('Êtes-vous sûr de vouloir refuser cette demande ?')">
                                            <i class="fas fa-times me-2"></i>Refuser l'invitation
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Actions du bas -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-center gap-3">
                        <a href="{{ path('collaboration_requests') }}" class="btn btn-outline-secondary order-2 order-sm-1">
                            <i class="fas fa-arrow-left me-2"></i>Retour aux demandes
                        </a>
                        
                        <div class="d-flex gap-2 order-1 order-sm-2">
                            {% if perspective == 'sender' and request.isPending %}
                                <form method="post" action="{{ path('collaboration_request_cancel', {id: request.id}) }}" class="d-inline">
                                    <input type="hidden" name="_token" value="{{ csrf_token('cancel-request-' ~ request.id) }}">
                                    <button class="btn btn-warning" 
                                            onclick="return confirm('Êtes-vous sûr de vouloir annuler cette demande ?')">
                                        <i class="fas fa-ban me-2"></i>Annuler la demande
                                    </button>
                                </form>
                            {% endif %}
                            
                            {% if request.isAccepted %}
                                <a href="{{ path('project_show', {id: request.project.id}) }}" class="btn btn-primary">
                                    <i class="fas fa-folder-open me-2"></i>Voir le projet
                                </a>
                            {% endif %}

                            {% if not request.isPending and not request.isAccepted %}
                                <a href="{{ path('project_index') }}" class="btn btn-outline-primary">
                                    <i class="fas fa-folder me-2"></i>Mes projets
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}